"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var _typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_slicedToArray=function(){function sliceIterator(arr,i){var _arr=[],_n=!0,_d=!1,_e=void 0;try{for(var _s,_i=arr[Symbol.iterator]();!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{!_n&&_i.return&&_i.return()}finally{if(_d)throw _e}}return _arr}return function(arr,i){if(Array.isArray(arr))return arr;if(Symbol.iterator in Object(arr))return sliceIterator(arr,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}();define("ReceivedOrders",["common"],function(util){var $=util.$,ko=util.ko;ko.mapping=util.mapping;var Item=function(item){var self=this;self.name=ko.observable(item&&item.name?item.name:""),self.quantity=ko.observable(item&&item.quantity?item.quantity:"1"),self.note=ko.observable(item&&item.note?item.note:""),self.buyPrice=item&&!isNaN(item.buyPrice)?item.buyPrice:"",self.sellPrice=item&&!isNaN(item.sellPrice)?item.sellPrice:"",self.profit=item&&item.profit?item.profit:"",self.isDone=!(!item||void 0===item.isDone)&&item.isDone,self.tag=item&&item.tag?item.tag:"",self.isLiveSearch=!1,self.bindLiveSearch=function(data,event){self.isLiveSearch||(self.isLiveSearch=!0,$(event.target).dropdown({itemType:"product",trigger:!0}))},self.isChanged=!1,self.name.subscribe(function(newValue){self.isChanged=!0}),self.quantity.subscribe(function(newValue){self.isChanged=!0}),self.note.subscribe(function(newValue){self.isChanged=!0})},OrderModel=function(order,swiper){var self=this;self._id=ko.observable(order&&order._id?order._id:""),self.client=ko.observable(order&&order.client?order.client:""),self.packingStatus=ko.observable(order&&order.packingStatus?order.packingStatus:"1ISREADY"),self.rate=order&&order.rate?order.rate:null,self.postage=order&&order.postage?order.postage:0,self.buyPrice=order&&order.buyPrice?order.buyPrice:"",self.sellPrice=order&&order.sellPrice?order.sellPrice:"",self.profit=order&&order.profit?order.profit:"",self.status=order&&order.status?order.status:"1RECEIVED",self.createDate=order&&order.createDate?order.createDate:"",self.isLiveSearch=!1,self.bindLiveSearch=function(data,event){self.isLiveSearch||(self.isLiveSearch=!0,$(event.target).dropdown({itemType:"client",trigger:!0}))};var dateFormatting={month:"2-digit",day:"numeric",weekday:"short"};self.displayDate=self.createDate?new Date(self.createDate).toLocaleDateString("en-US",dateFormatting):"";var observableItems=[];if(order&&$.isArray(order.items)&&order.items.length>0)order.items.forEach(function(item){observableItems.push(new Item(item))});else for(var i=0;i<3;i++)observableItems.push(new Item);self.items=ko.observableArray(observableItems),self.isChanged=!1,self.client.subscribe(function(newValue){self.isChanged=!0}),self.items.subscribe(function(newValue){self.isChanged=!0}),self.addItem=function(){self.items.unshift(new Item),swiper.update()},self.removeItem=function(item){self.items.remove(item),swiper.update()},self.orderPackingStatus=ko.pureComputed(function(){return"3PACKED"==self.packingStatus()?"font-green":"2NOTREADY"==self.packingStatus()?"font-yellow":"font-black"}),self.orderReadyStatus=ko.pureComputed(function(){return"2NOTREADY"==self.packingStatus()?"icon-thumbsdown font-yellow":"icon-thumbsup font-black"})};return function(orders,mySwiper){function init(orders){var observableOrders=[];if(Array.isArray(orders)&&orders.length>0)orders.forEach(function(order){observableOrders.push(new OrderModel(order,swiper))});else for(var i=0;i<30;i++)observableOrders.push(new OrderModel(null,swiper));return observableOrders}function sortOrders(orders){orders.sort(function(orderA,orderB){var aStatus=orderA.packingStatus(),bStatus=orderB.packingStatus();return aStatus==bStatus?orderA.createDate<=orderB.createDate?1:-1:aStatus<bStatus?-1:1})}function updateSwiper(){setTimeout(function(){swiper.update()},100)}var swiper=mySwiper,self=this;self.setSwiper=function(mySwiper){swiper=mySwiper,updateSwiper()};var observableOrders=init(orders);self.orders=ko.observableArray(observableOrders),self.setOrders=function(orders,isInitial){self.orders(init(orders)),updateSwiper()},self.submitOrder=function(order){arguments[3]();var succeed=arguments[4];console.log("post request....");var orderData=ko.mapping.toJS(order);return $.post("./order",orderData,function(data,status){console.log("get post result"),ko.mapping.fromJS(data,{},order),succeed()},"json"),!1},self.submitOrders=function(){arguments[3]();var succeed=arguments[4],orders=self.orders(),ordersData=$.parseJSON(ko.toJSON(orders));if(Array.isArray(ordersData)&&ordersData.length>0){var changedIndexs=[],changedOrders=ordersData.filter(function(order,index){var isChanged=!1;if(""!=order.client)if(order.isChanged)isChanged=!0;else for(var i=0;i<order.items.length;i++)if(order.items[i].isChanged){isChanged=!0;break}return isChanged&&changedIndexs.push(index),isChanged});changedOrders.length>0?$.post("./orders",{orders:changedOrders},function(rs,status){rs.forEach(function(newOrder,index){var orderIndex=changedIndexs[index];$.isArray(newOrder.items)&&0==newOrder.items.length&&(newOrder.items=[{},{},{}]),ko.mapping.fromJS(newOrder,{items:{create:function(option){return new Item(option.data)}}},orders[orderIndex]),orders[orderIndex].isChanged=!1}),succeed()},"json"):succeed()}return!1},self.markPackingStatus=function(order){var $target=$(arguments[2].target),packingStatus=order.packingStatus();if(!$target.hasClass("icon-leaf")||"2NOTREADY"!=packingStatus){arguments[3]();var succeed=arguments[4],id=(arguments[1],order._id()),newStatus="";if($target.hasClass("icon-leaf")?"1ISREADY"==packingStatus?newStatus="3PACKED":"3PACKED"==packingStatus&&(newStatus="1ISREADY"):newStatus="1ISREADY"==packingStatus||"3PACKED"==packingStatus?"2NOTREADY":"1ISREADY",""==newStatus)return void succeed();$.ajax("./packingStatus/"+id,{success:function(data,status){if(order.packingStatus(newStatus),""==$("#search-receivedOrders").val()){var orders=self.orders();sortOrders(orders),self.orders(orders)}succeed()},data:{packingStatus:newStatus},dataType:"json",type:"PUT"})}},self.addOrder=function(){var order=new OrderModel(null,swiper);self.orders.unshift(order),updateSwiper(),$(window).scrollTop(0)},self.removeOrder=function(order){arguments[3]();var succeed=arguments[4],id=order._id();if(self.orders.remove(order),""==id)return void succeed();$.ajax("./order/"+id,{success:function(data,status){succeed()},dataType:"json",type:"DELETE"}),updateSwiper()};var orders=null;self.searchOrders=function(data,event){var keywords=$(event.target).val();if(null==orders&&(orders=self.orders()),""==keywords){sortOrders(orders);var searchedOrders=orders}else var searchedOrders=orders.filter(function(order){return order.client().indexOf(keywords)>=0});self.orders(searchedOrders),updateSwiper()},self.afterRender=function(){updateSwiper(),$(".mask").removeClass("isShow")},self.afterOrderRender=function(){$("#receivedOrdersBody").children().length===self.orders().length&&updateSwiper()}}}),define("ItemsModel",["common"],function(util){var $=util.$,ko=util.ko;ko.mapping=util.mapping;var SubItem=function(subItem){var self=this;self._id=subItem._id,self.client=subItem.client,self.name=subItem.name,self.note=subItem.note,self.quantity=subItem.quantity,self.isDone=ko.observable(subItem.isDone)},Item=function(item,swiper){function synchronizePurchaseDetail(allItems){var index=allItems.findIndex(function(_item){return _item._id==self._id&&_item.tag==self.tag()});index>-1&&(allItems[index]=ko.mapping.toJS(self))}var self=this;self._id=item&&item._id?item._id:"",self.quantity=item?item.quantity:"",self.tag=ko.observable(item&&item.tag?item.tag:""),self.purchaseDetail=ko.observableArray(item?item.purchaseDetail:[]),self.getEmptyCss=function(){if(!self.tag())return"isEmpty"},self.subItems=ko.observableArray([]),self.updateSubItems=function(subItems){var newSubItems=[];Array.isArray(subItems)&&subItems.length>0&&subItems.forEach(function(_item){newSubItems.push(new SubItem(_item))}),self.subItems(newSubItems)},self.hasItemDetail=function(subItem){return self.subItems().length>0},self.restCount=ko.pureComputed(function(){var purchaseDetail=self.purchaseDetail(),isDone=0,notDone=0;return purchaseDetail.forEach(function(item){item.isDone?isDone=item.quantity:notDone=item.quantity}),isDone<self.quantity&&0!=isDone?self.quantity-isDone:""}),self.displaySubItems=ko.pureComputed(function(){return self.subItems().length>0}),self.isLiveSearch=!1,self.bindLiveSearch=function(){self.isLiveSearch||(self.isLiveSearch=!0,$(arguments[2].target).tag({itemName:self._id,trigger:!0}))},self.markDone=function(item,parent,event){arguments[3]();var succeed=arguments[4],itemData=ko.mapping.toJS(item),isPurchased=!0;itemData.purchaseDetail.forEach(function(item){item.isDone||(isPurchased=!1)}),$.post("./item",{itemTag:itemData.tag,itemName:itemData._id,isDone:!isPurchased},function(res,status){item.purchaseDetail(res.purchaseDetail),synchronizePurchaseDetail(parent.allItems);self.displaySubItems&&self.subItems().forEach(function(_item){_item.isDone(!isPurchased)}),succeed()},"json")},self.markItemStatus=function(){var purchaseDetail=self.purchaseDetail(),isDone=0,notDone=0;return purchaseDetail.forEach(function(item){item.isDone?isDone=item.quantity:notDone=item.quantity}),notDone==self.quantity?"":isDone==self.quantity?"font-green":"font-yellow"},self.markSubItemDone=function(subItem,parent,event){arguments[3]();var succeed=arguments[4],root=arguments[5],subItemData=ko.mapping.toJS(subItem);subItemData.isDone=!subItemData.isDone,subItemData.tag=parent.tag(),$.post("./subitem",subItemData,function(res,status){subItem.isDone(!subItem.isDone()),self.purchaseDetail(res.purchaseDetail),synchronizePurchaseDetail(root.allItems),self.subItems().forEach(function(_item){_item.client==subItem.client&&_item.isDone(subItem.isDone())}),succeed()},"json")},self.getSubName=function(item){return"item"+item.isDone},self.getSubItems=function(item,parent,event){var itemData=ko.mapping.toJS(item);if(item.isSubItemsOpen())$(event.target).parents(".orderitem-cnt").next().slideUp("fast",function(){item.isSubItemsOpen(!1),swiper.update()});else{arguments[3]();var succeed=arguments[4];$.getJSON("./subitems",{itemName:itemData._id,itemTag:itemData.tag},function(res,status){"success"==status?self.updateSubItems(res):item.subItems([]),$(event.target).parents(".orderitem-cnt").next().slideDown("fast",function(){item.isSubItemsOpen(!0),succeed()})})}},self.getExpandCollapse=function(){return self.isSubItemsOpen()?"icon-collapse":"icon-expand"},self.isSubItemsOpen=ko.observable(!1)};return function(items,swiper){function convertPurchaseStatus(item){var detail="function"==typeof item.purchaseDetail?item.purchaseDetail():item.purchaseDetail,isDone=0,notDone=0;return detail.forEach(function(_item){_item.isDone?isDone=_item.quantity:notDone=_item.quantity}),notDone==item.quantity?-1:isDone==item.quantity?1:0}function compareTag(itemA,itemB){if(itemA.tag<itemB.tag)return-1;if(itemA.tag>itemB.tag)return 1;var statusNumberA=convertPurchaseStatus(itemA),statusNumberB=convertPurchaseStatus(itemB);if(statusNumberA<statusNumberB)return-1;if(statusNumberA>statusNumberB)return 1;var aFirstLetter=itemA._id.substr(0,1),bFirstLetter=itemB._id.substr(0,1);return aFirstLetter<bFirstLetter?-1:aFirstLetter>bFirstLetter?1:0}function compareStatus(itemA,itemB){var statusNumberA=convertPurchaseStatus(itemA),statusNumberB=convertPurchaseStatus(itemB);if(statusNumberA<statusNumberB)return-1;if(statusNumberA>statusNumberB)return 1;if(itemA.tag<itemB.tag)return-1;if(itemA.tag>itemB.tag)return 1;var aFirstLetter=itemA._id.substr(0,1),bFirstLetter=itemB._id.substr(0,1);return aFirstLetter<bFirstLetter?-1:aFirstLetter>bFirstLetter?1:0}function init(items,needRefreshTag,orderBy){var observableItems=[],tags=[];return Array.isArray(items)&&items.length>0&&("status"==orderBy?items.sort(compareStatus):items.sort(compareTag),items.forEach(function(item){observableItems.push(new Item(item,swiper)),needRefreshTag&&tags.indexOf(item.tag)<0&&item.tag&&tags.push(item.tag)})),[observableItems,tags]}var self=this;self.allItems=[],self.tags=ko.observableArray(),self.items=ko.observableArray(),self.setItems=function(items,isAll,needBinding){var needRefreshTag=!1;isAll&&($(".link-tag.all").addClass("isActive"),needRefreshTag=!0);var _init=init(items,needRefreshTag),_init2=_slicedToArray(_init,2),items=_init2[0],tags=_init2[1];self.items(items),isAll&&(self.tags(tags),self.allItems=self.items().map(function(item){return ko.mapping.toJS(item)})),setTimeout(function(){swiper.update()},100)},self.setItems(items,!0,!1),self.refreshItems=function(sortfield){var currentItems=self.items().map(function(item){return ko.mapping.toJS(item)}),$currentTab=$(".link-tag.isActive");$currentTab.hasClass("all")||(currentItems=currentItems.filter(function(item){return item.tag==$currentTab.text()}));var _init3=init(currentItems,!1,sortfield),_init4=_slicedToArray(_init3,2),items=_init4[0];_init4[1];self.items(items)},self.filterItems=function(tag,parent,event){var $currentTag=$(event.target);if($(".link-tag.isActive").removeClass("isActive"),$currentTag.addClass("isActive"),$currentTag.hasClass("all"))self.setItems(self.allItems,!0,!0);else{var specificItems=self.allItems.filter(function(item){return item.tag==tag});self.setItems(specificItems,!1,!0)}swiper.update(),$(document).click()},self.afterRender=function(){swiper.update()}}}),define("ReckoningOrders",["common"],function(util){function getDoneOrderStartDate(){var currentMiliSeconds=Date.now(),currentDay=(new Date).getDay(),startMiliSeconds=currentMiliSeconds-24*(currentDay+7)*60*60*1e3;return new Date(new Date(startMiliSeconds).setHours(0,0,0,0))}var $=util.$,ko=util.ko;ko.mapping=util.mapping;var Item=function(item){function removeDoubt(price){var purePrice=price;return"string"==typeof purePrice&&purePrice.startsWith("?")&&(purePrice=purePrice.slice(1),self.isChanged=!0),purePrice}var self=this;self.name=ko.observable(item&&item.name?item.name:""),self.quantity=ko.observable(item&&item.quantity?item.quantity:"1"),self.buyPrice=ko.observable(item&&item.buyPrice?removeDoubt(item.buyPrice):""),self.sellPrice=ko.observable(item&&item.sellPrice?removeDoubt(item.sellPrice):""),self.profit=item&&item.profit?item.profit:"",self.note=item&&item.note?item.note:"",self.isDone=!(!item||!item.isDone)&&item.isDone,self.tag=item&&item.tag?item.tag:"",self.historicTrades=ko.observableArray([]),self.isDoubtSellPrice=ko.observable(item&&item.isDoubtSellPrice||!1),self.isDoubtBuyPrice=ko.observable(item&&item.isDoubtBuyPrice||!1),self.isLiveSearch=!1,self.bindLiveSearch=function(data,event){self.isLiveSearch||(self.isLiveSearch=!0,$(event.target).dropdown({itemType:"product",trigger:!0,afterChosen:function(_ref){var _ref$sellPrice=_ref.sellPrice,sellPrice=void 0===_ref$sellPrice?"":_ref$sellPrice,_ref$buyPrice=_ref.buyPrice,buyPrice=void 0===_ref$buyPrice?"":_ref$buyPrice;(self.isDoubtSellPrice()||""==self.sellPrice())&&(self.sellPrice(sellPrice),self.isDoubtSellPrice(!0)),(self.isDoubtBuyPrice()||""==self.buyPrice())&&(self.buyPrice(buyPrice),self.isDoubtBuyPrice(!0))}}))},self.isHistoricTradesOpen=!1,self.isChanged=!1,self.name.subscribe(function(newValue){self.isChanged=!0}),self.quantity.subscribe(function(newValue){self.isChanged=!0}),self.buyPrice.subscribe(function(newVal){self.isChanged=!0}),self.sellPrice.subscribe(function(newVal){self.isChanged=!0})},OrderModel=function(order,swiper){var self=this;self._id=ko.observable(order?order._id:""),self.client=ko.observable(order?order.client:""),self.postage=ko.observable(order&&order.postage?order.postage:0);var observableItems=[];if(order&&$.isArray(order.items)&&order.items.length>0)order.items.forEach(function(item){observableItems.push(new Item(item))});else for(var i=0;i<3;i++)observableItems.push(new Item);self.isChanged=order&&order.isChanged,self.items=ko.observableArray(observableItems),self.items.subscribe(function(newValue){self.isChanged=!0}),self.client.subscribe(function(newValue){self.isChanged=!0}),self.postage.subscribe(function(newValue){self.isChanged=!0}),self.createDate=ko.observable(order?order.createDate:""),self.displayDate=ko.observable(order?order.displayDate:""),self.rate=order?order.rate:"",self.buyPrice=ko.observable(order&&order.buyPrice?order.buyPrice:""),self.sellPrice=ko.observable(order&&order.sellPrice?order.sellPrice:""),self.profit=ko.observable(order&&order.profit?order.profit:""),self.isComplete=ko.observable(!(!order||!order.isComplete)&&order.isComplete),self.isLiveSearch=!1,self.bindLiveSearch=function(data,event){self.isLiveSearch||(self.isLiveSearch=!0,$(event.target).dropdown({itemType:"client",trigger:!0}))},self.formatPrice=function(price){if(!price)return"?";var purePrice=price();return purePrice?(+purePrice).toFixed(1):"?"},self.total=ko.pureComputed(function(){var sellPrice=parseFloat(this.sellPrice()),postage=parseFloat(this.postage());return isNaN(sellPrice)||isNaN(postage)?"?":(sellPrice+postage).toFixed(1)},self);self.status=ko.observable(order?order.status:"1RECEIVED"),self.packingStatus=order?order.packingStatus:"1ISREADY",self.orderStatus=ko.pureComputed(function(){return"3DONE"==self.status()?"font-green":"2SENT"==self.status()?"font-yellow":"3PACKED"!=self.packingStatus?"font-grey":void 0}),self.getHistoricTrades=function(item,parent,event){var itemData=ko.mapping.toJS(item),$historicTrades=$(event.target).closest(".itembox--reckoning").find(".historicbox");if(item.isHistoricTradesOpen)$historicTrades.slideUp("fast",function(){item.isHistoricTradesOpen=!1,swiper.update()});else{var succeed=arguments[4];if(""==itemData.name)return;arguments[3](),$.getJSON("./historictrades",{itemName:itemData.name},function(res,status){"success"==status?item.historicTrades(res):item.historicTrades([]),$historicTrades.slideDown("fast",function(){item.isHistoricTradesOpen=!0,succeed()})})}},self.hasHistoricTrades=function(item){return item.historicTrades().length>0},self.addItem=function(){self.items.unshift(new Item),swiper.update()},self.removeItem=function(item){self.items.remove(item),swiper.update()},self.addClient=function(client){var _self$clients$unshift;self.clients.unshift((_self$clients$unshift={_id:"",client:self.client(),recipient:""},_defineProperty(_self$clients$unshift,"client",""),_defineProperty(_self$clients$unshift,"phone",""),_self$clients$unshift)),swiper.update()},self.getClients=function(order){arguments[3]();var succeed=arguments[4],client=order.client();""!=client&&$.getJSON("./clientsByClient",{client:client},function(res,status){"success"==status?order.clients(res):order.clients([]),succeed()})};var removedClients=[];self.removeClient=function(client){""!=client._id&&removedClients.push(client._id),self.clients.remove(client),swiper.update()},self.submitClients=function(order){arguments[3]();var succeed=arguments[4],clientsData=ko.mapping.toJS(order.clients);return $.post("./clients",{client:order.client,clients:clientsData},function(clients,status){order.clients(clients),succeed()},"json"),!1},self.submitOrder=function(order){arguments[3]();var orderData=(arguments[4],$.parseJSON(ko.toJSON(order)));return $.post("./order",orderData,function(data,status){data.items.forEach(function(item){item.historicTrades=[]}),console.log("get post result"),ko.mapping.fromJS(data,{},order)},"json"),!1}};return function(orders,swiper){function updateSwiper(){setTimeout(function(){swiper.update()},100)}function searchCurrentOrders(){var targetStatus="";"b"==appending?targetStatus="1RECEIVED":"y"==appending?targetStatus="2SENT":"g"==appending&&(targetStatus="3DONE");var searchedOrders=reservedOrders.filter(function(order){var includingKeywords=order.client().indexOf(newKeywords)>=0;return""!=targetStatus?includingKeywords&&order.status()==targetStatus:includingKeywords});self.orders(searchedOrders)}function searchGlobalOrders(){var id=setTimeout(function(){for(var i=1;i<timeoutIds.length;i++)clearTimeout(timeoutIds[i]);if(timeoutIds=[],""!=newKeywords){var targetStatus="";"b"==appending?targetStatus="1RECEIVED":"y"==appending?targetStatus="2SENT":"g"==appending&&(targetStatus="3DONE");var condition={client:newKeywords};""!=targetStatus&&(condition.status=targetStatus),$.ajax("./ordersByName",{data:condition,type:"GET",success:function(data,status){/^\s?$/.test(newKeywords)||self.orders(self.getObservableOrders(data))},dataType:"json"}),console.log("i am searching "+newKeywords)}},1e3);timeoutIds.push(id)}var self=this,startDate=getDoneOrderStartDate();self.updateReservedOrders=function(orders){reservedOrders=orders},self.sortOrders=function(orders){orders.sort(function(orderA,orderB){var aStatus=orderA.status(),bStatus=orderB.status();return aStatus==bStatus?orderA.createDate()<=orderB.createDate()?1:-1:aStatus<bStatus?-1:1})},self.getObservableOrders=function(orders){var observableOrders=[];return orders.forEach(function(order){observableOrders.push(new OrderModel(order,swiper))}),observableOrders};var observableOrders=self.getObservableOrders(orders);self.orders=ko.observableArray(observableOrders),self.toggleClientView=function(data,parent,event){$(event.target).toggleClass("icon-eyeslash");var $orders=$(".orders--reckoning");$(event.target).hasClass("icon-eyeslash")?$orders.addClass("isClientView"):$orders.removeClass("isClientView"),swiper.update()},self.markDone=function(order){arguments[3]();var succeed=arguments[4],id=(arguments[1],order._id()),orderStatus=order.status(),newStatus="1RECEIVED";"1RECEIVED"==orderStatus?newStatus="2SENT":"2SENT"==orderStatus&&(newStatus="3DONE"),$.ajax("./orderStatus/"+id,{success:function(data,status){order.status(newStatus);var orders=self.orders();""==$("#search-reckoningOrders").val()?("3DONE"==newStatus&&order.createDate()<startDate&&self.removeDoneOrder(order),self.sortOrders(orders),self.orders(orders),self.updateReservedOrders(orders)):needRefresh=!0,succeed()},data:{status:newStatus},dataType:"json",type:"PUT"})},self.submitOrders=function(){arguments[3]();var succeed=arguments[4],orders=self.orders(),ordersData=$.parseJSON(ko.toJSON(orders));if(Array.isArray(ordersData)&&ordersData.length>0){var changedIndexs=[],changedOrders=ordersData.filter(function(order,index){var isChanged=!1;if(order.isChanged)isChanged=!0;else for(var i=0;i<order.items.length;i++)if(order.items[i].isChanged){isChanged=!0;break}return isChanged&&changedIndexs.push(index),isChanged});changedOrders.length>0?(needRefresh=!!isSearchStatus,$.post("./orders",{orders:changedOrders},function(rs,status){rs.forEach(function(newOrder,index){var orderIndex=changedIndexs[index];$.isArray(newOrder.items)&&0==newOrder.items.length&&(newOrder.items=[{},{},{}]),newOrder.items.forEach(function(item){item.historicTrades=[]}),ko.mapping.fromJS(newOrder,{items:{create:function(option){return new Item(option.data)}}},orders[orderIndex]),orders[orderIndex].isChanged=!1}),succeed()},"json")):succeed()}return!1},self.afterRender=function(){updateSwiper(),$(".icon-question").colorbox({inline:!0,href:"#manual-search",width:335,height:200,scrolling:!1,close:"",top:0,onComplete:function(){setInterval(function(){$.colorbox.resize()},200)}})},self.afterOrderRender=function(){$("#reckoningOrdersBody").children().length===self.orders().length&&updateSwiper()},self.addOrder=function(){var order=new OrderModel(null,swiper);self.orders.unshift(order),self.updateReservedOrders(self.orders()),swiper.update(),$(window).scrollTop(0)},self.addExistingOrder=function(order){self.orders.push(doneOrder)},self.removeDoneOrder=function(doneOrder){self.orders.remove(doneOrder)},self.removeOrder=function(order){arguments[3]();var succeed=arguments[4],id=order._id();if(self.orders.remove(order),""==id)return void succeed();$.ajax("./order/"+id,{success:function(data,status){succeed()},dataType:"json",type:"DELETE"}),self.updateReservedOrders(self.orders()),swiper.update()};var reservedOrders,needRefresh,isSearchStatus,newKeywords,isDoing,appending;self.searchOrders=function(data,event){var keywords=$(event.target).val(),matchedRes=keywords.match(/(\s*)([\u4E00-\u9FA5\uF900-\uFA2D\w ]*)([\/\uff0f][bgy])?/);reservedOrders||(reservedOrders=self.orders()),null!=matchedRes&&(isSearchStatus=!0,newKeywords=matchedRes[2],appending=matchedRes[3]&&matchedRes[3].substr(1),/^\s?$/.test(keywords)?(newKeywords="",isSearchStatus=!1,isDoing=!1,needRefresh&&!isDoing?(isDoing=!0,$.getJSON("./reckoningOrdersJson",function(orders,status){needRefresh=!1,isDoing=!1;var observableOrders=self.getObservableOrders(orders);self.orders(observableOrders),reservedOrders=observableOrders})):(self.sortOrders(reservedOrders),self.orders(reservedOrders))):""==matchedRes[1]?searchCurrentOrders():searchGlobalOrders())};var timeoutIds=[]}}),define("IncomeList",["common"],function(util){var $=util.$,ko=util.ko;return ko.mapping=util.mapping,function(incomeList,swiper){var swiper=swiper,self=this;self.incomeList=ko.observableArray(incomeList),self.setIncomeList=function(incomeList){self.incomeList(incomeList)},self.formatPrice=function(price){return price?(+price).toFixed(1):"?"},self.toggleTotalView=function(data,parent,event){$(event.target).toggleClass("icon-eyeopen");var $order=$(event.target).closest(".orderitem-cnt");$(event.target).hasClass("icon-eyeopen")?$order.addClass("isShow"):$order.removeClass("isShow")},self.afterRender=function(){swiper.update()}}}),function(f){if("object"===("undefined"==typeof exports?"undefined":_typeof2(exports))&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define("clipboard",[],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.Clipboard=f()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){function closest(element,selector){for(;element&&element.nodeType!==DOCUMENT_NODE_TYPE;){if(element.matches(selector))return element;element=element.parentNode}}var DOCUMENT_NODE_TYPE=9;if("undefined"!=typeof Element&&!Element.prototype.matches){var proto=Element.prototype;proto.matches=proto.matchesSelector||proto.mozMatchesSelector||proto.msMatchesSelector||proto.oMatchesSelector||proto.webkitMatchesSelector}module.exports=closest},{}],2:[function(require,module,exports){function delegate(element,selector,type,callback,useCapture){var listenerFn=listener.apply(this,arguments);return element.addEventListener(type,listenerFn,useCapture),{destroy:function(){element.removeEventListener(type,listenerFn,useCapture)}}}function listener(element,selector,type,callback){return function(e){e.delegateTarget=closest(e.target,selector),e.delegateTarget&&callback.call(element,e)}}var closest=require("./closest");module.exports=delegate},{"./closest":1}],3:[function(require,module,exports){exports.node=function(value){return void 0!==value&&value instanceof HTMLElement&&1===value.nodeType},exports.nodeList=function(value){var type=Object.prototype.toString.call(value);return void 0!==value&&("[object NodeList]"===type||"[object HTMLCollection]"===type)&&"length"in value&&(0===value.length||exports.node(value[0]))},exports.string=function(value){return"string"==typeof value||value instanceof String},exports.fn=function(value){return"[object Function]"===Object.prototype.toString.call(value)}},{}],4:[function(require,module,exports){function listen(target,type,callback){if(!target&&!type&&!callback)throw new Error("Missing required arguments");if(!is.string(type))throw new TypeError("Second argument must be a String");if(!is.fn(callback))throw new TypeError("Third argument must be a Function");if(is.node(target))return listenNode(target,type,callback);if(is.nodeList(target))return listenNodeList(target,type,callback);if(is.string(target))return listenSelector(target,type,callback);throw new TypeError("First argument must be a String, HTMLElement, HTMLCollection, or NodeList")}function listenNode(node,type,callback){return node.addEventListener(type,callback),{destroy:function(){node.removeEventListener(type,callback)}}}function listenNodeList(nodeList,type,callback){return Array.prototype.forEach.call(nodeList,function(node){node.addEventListener(type,callback)}),{destroy:function(){Array.prototype.forEach.call(nodeList,function(node){node.removeEventListener(type,callback)})}}}function listenSelector(selector,type,callback){return delegate(document.body,selector,type,callback)}var is=require("./is"),delegate=require("delegate");module.exports=listen},{"./is":3,delegate:2}],5:[function(require,module,exports){function select(element){var selectedText;if("SELECT"===element.nodeName)element.focus(),selectedText=element.value;else if("INPUT"===element.nodeName||"TEXTAREA"===element.nodeName){var isReadOnly=element.hasAttribute("readonly");isReadOnly||element.setAttribute("readonly",""),element.select(),element.setSelectionRange(0,element.value.length),isReadOnly||element.removeAttribute("readonly"),selectedText=element.value}else{element.hasAttribute("contenteditable")&&element.focus();var selection=window.getSelection(),range=document.createRange();range.selectNodeContents(element),selection.removeAllRanges(),selection.addRange(range),selectedText=selection.toString()}return selectedText}module.exports=select},{}],6:[function(require,module,exports){function E(){}E.prototype={on:function(name,callback,ctx){var e=this.e||(this.e={});return(e[name]||(e[name]=[])).push({fn:callback,ctx:ctx}),this},once:function(name,callback,ctx){function listener(){self.off(name,listener),callback.apply(ctx,arguments)}var self=this;return listener._=callback,this.on(name,listener,ctx)},emit:function(name){var data=[].slice.call(arguments,1),evtArr=((this.e||(this.e={}))[name]||[]).slice(),i=0,len=evtArr.length;for(i;i<len;i++)evtArr[i].fn.apply(evtArr[i].ctx,data);return this},off:function(name,callback){var e=this.e||(this.e={}),evts=e[name],liveEvents=[];if(evts&&callback)for(var i=0,len=evts.length;i<len;i++)evts[i].fn!==callback&&evts[i].fn._!==callback&&liveEvents.push(evts[i]);return liveEvents.length?e[name]=liveEvents:delete e[name],this}},module.exports=E},{}],7:[function(require,module,exports){!function(global,factory){if("function"==typeof define&&define.amd)define(["module","select"],factory);else if(void 0!==exports)factory(module,require("select"));else{var mod={exports:{}};factory(mod,global.select),global.clipboardAction=mod.exports}}(this,function(module,_select){function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _select2=function(obj){return obj&&obj.__esModule?obj:{default:obj}}(_select),_typeof="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(obj){return void 0===obj?"undefined":_typeof2(obj)}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":void 0===obj?"undefined":_typeof2(obj)},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),
Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),ClipboardAction=function(){function ClipboardAction(options){_classCallCheck(this,ClipboardAction),this.resolveOptions(options),this.initSelection()}return _createClass(ClipboardAction,[{key:"resolveOptions",value:function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.action=options.action,this.emitter=options.emitter,this.target=options.target,this.text=options.text,this.trigger=options.trigger,this.selectedText=""}},{key:"initSelection",value:function(){this.text?this.selectFake():this.target&&this.selectTarget()}},{key:"selectFake",value:function(){var _this=this,isRTL="rtl"==document.documentElement.getAttribute("dir");this.removeFake(),this.fakeHandlerCallback=function(){return _this.removeFake()},this.fakeHandler=document.body.addEventListener("click",this.fakeHandlerCallback)||!0,this.fakeElem=document.createElement("textarea"),this.fakeElem.style.fontSize="12pt",this.fakeElem.style.border="0",this.fakeElem.style.padding="0",this.fakeElem.style.margin="0",this.fakeElem.style.position="absolute",this.fakeElem.style[isRTL?"right":"left"]="-9999px";var yPosition=window.pageYOffset||document.documentElement.scrollTop;this.fakeElem.style.top=yPosition+"px",this.fakeElem.setAttribute("readonly",""),this.fakeElem.value=this.text,document.body.appendChild(this.fakeElem),this.selectedText=(0,_select2.default)(this.fakeElem),this.copyText()}},{key:"removeFake",value:function(){this.fakeHandler&&(document.body.removeEventListener("click",this.fakeHandlerCallback),this.fakeHandler=null,this.fakeHandlerCallback=null),this.fakeElem&&(document.body.removeChild(this.fakeElem),this.fakeElem=null)}},{key:"selectTarget",value:function(){this.selectedText=(0,_select2.default)(this.target),this.copyText()}},{key:"copyText",value:function(){var succeeded=void 0;try{succeeded=document.execCommand(this.action)}catch(err){succeeded=!1}this.handleResult(succeeded)}},{key:"handleResult",value:function(succeeded){this.emitter.emit(succeeded?"success":"error",{action:this.action,text:this.selectedText,trigger:this.trigger,clearSelection:this.clearSelection.bind(this)})}},{key:"clearSelection",value:function(){this.target&&this.target.blur(),window.getSelection().removeAllRanges()}},{key:"destroy",value:function(){this.removeFake()}},{key:"action",set:function(){var action=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"copy";if(this._action=action,"copy"!==this._action&&"cut"!==this._action)throw new Error('Invalid "action" value, use either "copy" or "cut"')},get:function(){return this._action}},{key:"target",set:function(target){if(void 0!==target){if(!target||"object"!==(void 0===target?"undefined":_typeof(target))||1!==target.nodeType)throw new Error('Invalid "target" value, use a valid Element');if("copy"===this.action&&target.hasAttribute("disabled"))throw new Error('Invalid "target" attribute. Please use "readonly" instead of "disabled" attribute');if("cut"===this.action&&(target.hasAttribute("readonly")||target.hasAttribute("disabled")))throw new Error('Invalid "target" attribute. You can\'t cut text from elements with "readonly" or "disabled" attributes');this._target=target}},get:function(){return this._target}}]),ClipboardAction}();module.exports=ClipboardAction})},{select:5}],8:[function(require,module,exports){!function(global,factory){if("function"==typeof define&&define.amd)define(["module","./clipboard-action","tiny-emitter","good-listener"],factory);else if(void 0!==exports)factory(module,require("./clipboard-action"),require("tiny-emitter"),require("good-listener"));else{var mod={exports:{}};factory(mod,global.clipboardAction,global.tinyEmitter,global.goodListener),global.clipboard=mod.exports}}(this,function(module,_clipboardAction,_tinyEmitter,_goodListener){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!==(void 0===call?"undefined":_typeof2(call))&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+(void 0===superClass?"undefined":_typeof2(superClass)));subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function getAttributeValue(suffix,element){var attribute="data-clipboard-"+suffix;if(element.hasAttribute(attribute))return element.getAttribute(attribute)}var _clipboardAction2=_interopRequireDefault(_clipboardAction),_tinyEmitter2=_interopRequireDefault(_tinyEmitter),_goodListener2=_interopRequireDefault(_goodListener),_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),Clipboard=function(_Emitter){function Clipboard(trigger,options){_classCallCheck(this,Clipboard);var _this=_possibleConstructorReturn(this,(Clipboard.__proto__||Object.getPrototypeOf(Clipboard)).call(this));return _this.resolveOptions(options),_this.listenClick(trigger),_this}return _inherits(Clipboard,_Emitter),_createClass(Clipboard,[{key:"resolveOptions",value:function(){var options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.action="function"==typeof options.action?options.action:this.defaultAction,this.target="function"==typeof options.target?options.target:this.defaultTarget,this.text="function"==typeof options.text?options.text:this.defaultText}},{key:"listenClick",value:function(trigger){var _this2=this;this.listener=(0,_goodListener2.default)(trigger,"click",function(e){return _this2.onClick(e)})}},{key:"onClick",value:function(e){var trigger=e.delegateTarget||e.currentTarget;this.clipboardAction&&(this.clipboardAction=null),this.clipboardAction=new _clipboardAction2.default({action:this.action(trigger),target:this.target(trigger),text:this.text(trigger),trigger:trigger,emitter:this})}},{key:"defaultAction",value:function(trigger){return getAttributeValue("action",trigger)}},{key:"defaultTarget",value:function(trigger){var selector=getAttributeValue("target",trigger);if(selector)return document.querySelector(selector)}},{key:"defaultText",value:function(trigger){return getAttributeValue("text",trigger)}},{key:"destroy",value:function(){this.listener.destroy(),this.clipboardAction&&(this.clipboardAction.destroy(),this.clipboardAction=null)}}],[{key:"isSupported",value:function(){var action=arguments.length>0&&void 0!==arguments[0]?arguments[0]:["copy","cut"],actions="string"==typeof action?[action]:action,support=!!document.queryCommandSupported;return actions.forEach(function(action){support=support&&!!document.queryCommandSupported(action)}),support}}]),Clipboard}(_tinyEmitter2.default);module.exports=Clipboard})},{"./clipboard-action":7,"good-listener":4,"tiny-emitter":6}]},{},[8])(8)}),define("ClientsModel",["common","clipboard"],function(util,Clipboard){var $=util.$,ko=util.ko;ko.mapping=util.mapping;var AddressModel=function(address){var self=this;self.recipient=ko.observable(address&&address.recipient?address.recipient:""),self.address=ko.observable(address&&address.address?address.address:""),self.phone=ko.observable(address&&address.phone?address.phone:""),self.isActive=ko.observable(!(!address||!address.isActive)),self.defaultAddressMarkCss=ko.pureComputed(function(){return self.isActive()?"icon-radio-selected":"icon-radio"}),self.defaultAddressCss=ko.pureComputed(function(){return self.isActive()?"isActive":""}),self.isChanged=!1,self.recipient.subscribe(function(newValue){self.isChanged=!0}),self.address.subscribe(function(newValue){self.isChanged=!0}),self.phone.subscribe(function(newVal){self.isChanged=!0}),self.isActive.subscribe(function(newVal){self.isChanged=!0})},ClientModel=function(client,swiper){var self=this;self._id=ko.observable(client?client._id:""),self.name=ko.observable(client?client.name:""),self.createDate=client&&client.createDate?client.createDate:"",self.isActive=ko.observable(!(!client||!client.isActive)),self.mailType=client&&client.mailType?client.mailType:"",self.mailDisplayType=function(mailType){return"sf"==mailType?"顺丰":"common"==mailType?"韵达":void 0},self.displayPrintName=function(recipient){recipient=recipient();var mail="";return""==recipient?"":"sf"==self.mailType?(mail="顺丰",recipient+" - "+mail):"common"==self.mailType?(mail="韵达",recipient+" - "+mail):recipient},client&&Array.isArray(client.addresses)&&client.addresses.length>0?self.addresses=ko.observableArray(client.addresses.map(function(address){return new AddressModel(address)})):self.addresses=ko.observableArray([new AddressModel({isActive:!0})]),self.isChanged=!1,self.name.subscribe(function(newValue){self.isChanged=!0}),self.addresses.subscribe(function(newValue){self.isChanged=!0}),self.addAddress=function(){self.addresses().length>0?self.addresses.unshift(new AddressModel):self.addresses.unshift(new AddressModel({isActive:!0})),swiper.update()},self.removeAddress=function(address){self.addresses.remove(address),swiper.update()},self.markDefault=function(address,parent){parent.addresses().forEach(function(address){return address.isActive(!1)}),address.isActive(!0)}};return function(clients,swiper){function classifyClients(){var clients=self.clients(),activeClients=clients.filter(function(client){client.name();return client.isActive()&&"common"==client.mailType}),agentClients=activeClients.filter(function(client){var name=client.name();return name.indexOf("-")>=0||name.indexOf("－")>=0}),agents=[];agentClients.forEach(function(client){var name=client.name(),sep_e=name.indexOf("-"),sep_c=name.indexOf("－"),sep=-1;sep=sep_e>-1&&sep_c>-1?Math.min(sep_e,sep_c):sep_e>-1?sep_e:sep_c;var agent=name.slice(0,sep);agents.find(function(_agent){return _agent==agent})||agents.push(agent)});var senders=[];agents.forEach(function(agent){var specificAgentClients=agentClients.filter(function(client){return client.name().startsWith(agent)}),rs=aggregateClients(agent,specificAgentClients);senders.push(rs)});var commonClients=activeClients.filter(function(client){var name=client.name();return name.indexOf("-")==-1&&name.indexOf("－")==-1});if(Array.isArray(commonClients)&&commonClients.length>0){var rs=aggregateClients("自己的",commonClients);senders.push(rs)}return senders}function aggregateClients(agent,clients){var addresses="";return clients.forEach(function(client){var address=client.addresses().find(function(address){return address.isActive()}),recipient=address.recipient(),phone=address.phone(),addressDetail=address.address();recipient&&phone&&addressDetail&&(addresses+=address.recipient()+"，"+address.phone()+"，"+address.address()+"；")}),{name:agent+"：",receives:addresses}}function init(clients){var observableClients=[];return clients.forEach(function(client){observableClients.push(new ClientModel(client,swiper))}),observableClients}function updateSwiper(){setTimeout(function(){swiper.update()},100)}function searchActiveClients(){var searchedClients=activeClients.filter(function(client){return client.name().indexOf(newKeywords)>=0});self.clients(searchedClients)}function searchGlobalClients(){var id=setTimeout(function(){for(var i=1;i<timeoutIds.length;i++)clearTimeout(timeoutIds[i]);timeoutIds=[],""!=newKeywords&&($.ajax("./clientsByKeywords",{data:{keywords:newKeywords},type:"GET",success:function(data,status){/^\s?$/.test(newKeywords)||self.clients(init(data))},dataType:"json"}),console.log("i am searching "+newKeywords))},1e3);timeoutIds.push(id)}var self=this;self.clients=ko.observableArray(init(clients)),self.senders=ko.observableArray(classifyClients()),self.setClients=function(clients){self.clients(init(clients)),self.senders(classifyClients())},self.setClientViews=function(clients){self.clients(clients)},self.setSenders=function(){self.senders(classifyClients())},self.addClient=function(){self.clients.unshift(new ClientModel(null,swiper)),updateSwiper()},self.removeClient=function(client){arguments[3]();var succeed=arguments[4],id=client._id();if(self.clients.remove(client),""==id)return swiper.update(),void succeed();$.ajax("./client/"+id,{success:function(data,status){succeed(),updateSwiper()},dataType:"json",type:"DELETE"}),needRefresh=!!isSearchStatus},self.submitClients=function(client){arguments[3]();var succeed=arguments[4],clients=self.clients();if(Array.isArray(clients)&&clients.length>0){var changedIndexs=[],changedClients=clients.filter(function(client,index){var isChanged=!1;if(""!=client.name)if(client.isChanged)isChanged=!0;else{var addresses=client.addresses(),changedAddress=addresses.find(function(address){return address.isChanged});changedAddress&&(isChanged=!0)}return isChanged&&changedIndexs.push(index),isChanged});if(changedClients.length>0){needRefresh=!!isSearchStatus;var clientsData=$.parseJSON(ko.toJSON(changedClients));$.post("./clients",{clients:clientsData},function(rs,status){rs.forEach(function(newClient,index){var orderIndex=changedIndexs[index];$.isArray(newClient.addresses)&&0==newClient.addresses.length&&(newClient.addresses=[{}]),ko.mapping.fromJS(newClient,{addresses:{create:function(option){return new AddressModel(option.data)}}},clients[orderIndex]),clients[orderIndex].isChanged=!1}),isSearchStatus||self.setSenders(),succeed()},"json")}else succeed()}return!1},self.afterRender=function(){updateSwiper()},self.afterSenderRender=function(){if($(".senders").children().length===self.senders().length){new Clipboard(".sender-copy",{text:function(trigger){return $(trigger).siblings(".sender-receives").val()}});updateSwiper()}},self.afterClientRender=function(){if($(".allclients").children().length===self.clients().length){new Clipboard(".sender-singleCopy",{text:function(trigger){var $activeAddress=$(trigger).closest(".client").find(".client-address.isActive");return $activeAddress.find(".recipient>input").val()+"，"+$activeAddress.find(".phone>input").val()+"，"+$activeAddress.find(".addressDetail>input").val()+"；"}});updateSwiper()}};var activeClients,needRefresh,isSearchStatus,newKeywords,isDoing;self.searchClients=function(data,event){var keywords=$(event.target).val(),matchedRes=keywords.match(/(\s*)([\u4E00-\u9FA5\uF900-\uFA2D\w]+[\u4E00-\u9FA5\uF900-\uFA2D\w ]*)/);activeClients||(activeClients=self.clients()),null!=matchedRes?(isSearchStatus=!0,newKeywords=matchedRes[2],""==matchedRes[1]?searchActiveClients():searchGlobalClients()):/^\s?$/.test(keywords)&&(newKeywords="",isSearchStatus=!1,isDoing=!1,needRefresh&&!isDoing?(isDoing=!0,$.getJSON("./clientsJson",function(clients,status){needRefresh=!1,isDoing=!1,self.setClients(clients),activeClients=self.clients()})):self.clients(activeClients))};var timeoutIds=[]}}),define("ProductsModel",["common"],function(util){function ProductClient(productClient){var self=this;self._id=productClient._id,self.client=productClient.client,self.name=productClient.name,self.note=productClient.note,self.buyPrice=ko.observable(productClient&&!isNaN(productClient.buyPrice)?productClient.buyPrice:""),self.sellPrice=ko.observable(productClient&&!isNaN(productClient.sellPrice)?productClient.sellPrice:"")}function Product(product,swiper){var self=this;self._id=ko.observable(product&&product._id?product._id:""),self.name=ko.observable(product&&product.name?product.name:""),self.status=ko.observable(product&&product.status?product.status:"MANUAL"),self.buyPrice=ko.observable(product&&!isNaN(product.buyPrice)?product.buyPrice:""),self.sellPrice=ko.observable(product&&!isNaN(product.sellPrice)?product.sellPrice:""),self.modifiedDate=ko.observable(product?product.modifiedDate:""),self.displayDate=ko.observable(product?product.displayDate:""),self.isChanged=!1,self.name.subscribe(function(newValue){self.isChanged=!0,product&&product.name&&newValue!=product.name&&self.status("MANUAL")}),self.buyPrice.subscribe(function(newValue){self.isChanged=!0,product&&product.buyPrice&&newValue!=product.buyPrice&&"MANUAL"!=product.status&&self.status("MODIFIED")}),self.sellPrice.subscribe(function(newValue){self.isChanged=!0,product&&product.sellPrice&&newValue!=product.sellPrice&&"MANUAL"!=product.status&&self.status("MODIFIED")}),self.activeClients=ko.observableArray([]),self.isOpen=ko.observable(!1),self.getActiveClients=function(product,parent,event){var $activeClients=$(event.target).closest(".table-row").children(".clientInfo");if(self.isOpen())$activeClients.slideUp("fast",function(){self.isOpen(!1),swiper.update()});else{arguments[3]();var succeed=arguments[4];$.getJSON("./activeClientsByProduct",{product:self.name()},function(productClients,status){if("success"==status&&Array.isArray(productClients)&&productClients.length>0){var activeClients=productClients.map(function(client){return new ProductClient(client)});self.activeClients(activeClients)}else self.activeClients([]);$activeClients.slideDown("fast",function(){self.isOpen(!0),succeed(),swiper.update()})})}},self.updateClientPrice=function(){arguments[3]();var succeed=arguments[4],activeClients=self.activeClients(),clientsData=$.parseJSON(ko.toJSON(activeClients));return $.post("./updateClientPrice",{clientProducts:clientsData},function(rs,status){succeed()},"json"),!1},self.getExpandCollapse=function(){return self.isOpen()?"icon-collapse":"icon-expand"}}function Products(products,swiper){function init(products){var productModels=[];if(Array.isArray(products))var productModels=products.map(function(product){return new Product(product,swiper)});return productModels}function updateSwiper(){setTimeout(function(){swiper.update()},100)}function searchActiveProducts(){var searchedProducts=activeProducts.filter(function(client){return client.name().indexOf(newKeywords)>=0});self.products(searchedProducts)}function searchGlobalProducts(){var id=setTimeout(function(){for(var i=1;i<timeoutIds.length;i++)clearTimeout(timeoutIds[i]);timeoutIds=[],""!=newKeywords&&($.ajax("./productsByKeywords",{data:{keywords:newKeywords},type:"GET",success:function(data,status){/^\s?$/.test(newKeywords)||self.setProducts(data)},dataType:"json"}),console.log("i am searching "+newKeywords))},1e3);timeoutIds.push(id)}var swiper=swiper,self=this;self.setProducts=function(products){self.products(init(products))},self.products=ko.observableArray(init(products)),self.submitProducts=function(){arguments[3]();var succeed=arguments[4],products=self.products(),productsData=$.parseJSON(ko.toJSON(products));if(Array.isArray(productsData)&&productsData.length>0){var changedIndexs=[],changedProducts=productsData.filter(function(product,index){var isChanged=!1;return""!=product.name&&product.isChanged&&(isChanged=!0),isChanged&&changedIndexs.push(index),isChanged});changedProducts.length>0?(needRefresh=!!isSearchStatus,$.post("./products",{products:changedProducts},function(rs,status){rs.forEach(function(newProduct,index){var orderIndex=changedIndexs[index];ko.mapping.fromJS(newProduct,null,products[orderIndex]),products[orderIndex].isChanged=!1}),succeed()},"json")):succeed()}return!1},self.addProduct=function(){var product=new Product(null,swiper);self.products.unshift(product),updateSwiper(),$(window).scrollTop(0)},self.removeProduct=function(product){arguments[3]();var succeed=arguments[4],id=product._id();if(self.products.remove(product),""==id)return void succeed();$.ajax("./product/"+id,{success:function(data,status){succeed(),updateSwiper()},dataType:"json",type:"DELETE"}),needRefresh=!!isSearchStatus},self.afterRender=function(){updateSwiper()},self.afterProductRender=function(){$("#productsbody").children().length===self.products().length&&updateSwiper()};var activeProducts,needRefresh,isSearchStatus,newKeywords,isDoing;self.searchProducts=function(data,event){var keywords=$(event.target).val(),matchedRes=keywords.match(/(\s*)([\u4E00-\u9FA5\uF900-\uFA2D\w]+[\u4E00-\u9FA5\uF900-\uFA2D\w ]*)/);activeProducts||(activeProducts=self.products()),null!=matchedRes?(isSearchStatus=!0,newKeywords=matchedRes[2],""==matchedRes[1]?searchActiveProducts():searchGlobalProducts()):/^\s?$/.test(keywords)&&(newKeywords="",isSearchStatus=!1,isDoing=!1,needRefresh&&!isDoing?(isDoing=!0,$.getJSON("./productsJson",function(products,status){needRefresh=!1,isDoing=!1,self.setProducts(products),activeProducts=self.products()})):self.products(activeProducts))};var timeoutIds=[]}var $=util.$,ko=util.ko;return ko.mapping=util.mapping,Products}),define("../js/main",["common","ReceivedOrders","ItemsModel","ReckoningOrders","IncomeList","ClientsModel","ProductsModel"],function(util,OrdersModel){function run(){function applyProductPrice(products,orders,_ref2){var buyComputing=_ref2.buyComputing,sellComputing=_ref2.sellComputing;"function"==typeof products&&(products=ko.mapping.toJS(products())),"function"==typeof orders&&(orders=ko.mapping.toJS(orders()));var productsWithPrice=products.filter(function(product){return product.sellPrice||product.buyPrice});return orders.forEach(function(order){"1RECEIVED"!=order.status&&"2SENT"!=order.status||order.items.forEach(function(item){var productWithPrice=productsWithPrice.find(function(product){return product.name==item.name});productWithPrice&&(sellComputing&&!item.sellPrice&&productWithPrice.sellPrice?(item.sellPrice="?"+productWithPrice.sellPrice,item.isDoubtSellPrice=!0,order.isChanged=!0):!sellComputing&&item.isDoubtSellPrice&&(item.sellPrice=null,item.isDoubtSellPrice=!1),buyComputing&&!item.buyPrice&&productWithPrice.buyPrice?(item.buyPrice="?"+productWithPrice.buyPrice,item.isDoubtBuyPrice=!0,order.isChanged=!0):!buyComputing&&item.isDoubtBuyPrice&&(item.buyPrice=null,item.isDoubtBuyPrice=!1))})}),orders}function setViewModelStatus(activeIndex){switch($(".swiper-slide")[activeIndex].id){case"receivedOrders":viewModelStatus.purchaseItems=!0,viewModelStatus.reckoningOrders=!0,viewModelStatus.clients=!0,viewModelStatus.products=!0;break;case"purchaseItems":viewModelStatus.receivedOrders=!0,viewModelStatus.reckoningOrders=!0;break;case"reckoningOrders":viewModelStatus.receivedOrders=!0,viewModelStatus.purchaseItems=!0,viewModelStatus.incomeList=!0,viewModelStatus.clients=!0,viewModelStatus.products=!0;break;case"products":viewModelStatus.reckoningOrders=!0}}function updateCurrentData(){var id=$(".swiper-slide")[swiper.activeIndex].id;"receivedOrders"==id&&$.getJSON("./receivedOrdersJson",function(orders,status){ordersModel.setOrders(orders,!0)}),"reckoningOrders"==id&&$.getJSON("./reckoningOrdersJson",function(orders,status){var observableOrders=reckoningOrdersModel.getObservableOrders(orders);reckoningOrdersModel.orders(observableOrders)})}function updateAllData(){var id=$(".swiper-slide")[swiper.activeIndex].id;"incomeList"!=id&&"reckoningOrders"!=id||$.getJSON("./receivedOrdersJson",function(orders,status){ordersModel.setOrders(orders,!0)}),"receivedOrders"!=id&&"reckoningOrders"!=id||$.getJSON("./purchaseItemsJson",function(rs,status){itemsModel.setItems(rs.items,!0,!0)}),"receivedOrders"!=id&&"incomeList"!=id||$.getJSON("./reckoningOrdersJson",function(orders,status){var observableOrders=reckoningOrdersModel.getObservableOrders(orders);reckoningOrdersModel.orders(observableOrders)}),"reckoningOrders"==id&&$.getJSON("./incomeListJson",function(incomeList,status){incomeListModel.setIncomeList(incomeList)}),"reckoningOrders"==id&&$.getJSON("./clientsJson",function(clients,status){clientsModel.setClients(clients)})}function getUserSetting(){return new Promise(function(resolve,reject){$.getJSON("./user/"+USER_ID,function(rs,status){resolve(rs)})})}var $=util.$,ko=util.ko,Swiper=(util.mapping,util.Swiper),viewModelStatus={receivedOrders:!1,purchaseItems:!1,reckoningOrders:!1,incomeList:!1,clients:!1,products:!1},swiper=new Swiper(".swiper-container",{autoHeight:!0,spaceBetween:30,pagination:".swiper-pagination",paginationClickable:!0,simulateTouch:!1,shortSwipes:!1,longSwipes:!1,paginationBulletRender:function(index,className){var bulletName="";switch($(".swiper-slide")[index].id){case"receivedOrders":bulletName="接单";break;case"purchaseItems":bulletName="采购";break;case"reckoningOrders":bulletName="算账";break;case"incomeList":bulletName="收益";break;case"clients":bulletName="客户";break;case"products":bulletName="产品"}return'<span class="'+className+'">'+bulletName+"</span>"}});util.initTapEvent({updateAllData:updateAllData,updateCurrentData:updateCurrentData,setViewModelStatus:setViewModelStatus,swiper:swiper});var itemsModel,reckoningOrdersModel,incomeListModel,clientsModel,productsModel,ordersModel=new OrdersModel(orders,swiper);ko.applyBindings(ordersModel,$("#receivedOrders")[0]);var userPromise=getUserSetting();userPromise.catch(function(reason){}),require(["common","ItemsModel","ReckoningOrders","IncomeList","ClientsModel","ProductsModel"],function(util,ItemsModel,OrdersModel,IncomeListModel,ClientsModel,ProductsModel){var $=util.$,ko=util.ko,purchasePromise=new Promise(function(resolve,reject){$.getJSON("./purchaseItemsJson",function(rs,status){itemsModel=new ItemsModel(rs.items,swiper),ko.applyBindings(itemsModel,$("#purchaseItems")[0]),resolve(itemsModel)})});Promise.all([userPromise,purchasePromise]).then(function(_ref3){var _ref4=_slicedToArray(_ref3,2),user=_ref4[0],itemsModel=_ref4[1],tags=Array.isArray(user.tags)?user.tags:[];$.fn.tag.globalSettings={tags:tags,updateTag:function(itemName,oldTag,newTag){if(oldTag!=newTag){if(Array.isArray(itemsModel.allItems)&&itemsModel.allItems.length>0){var item=itemsModel.allItems.find(function(item){return item._id==itemName});if(item){item.tag=newTag;var tags=[];itemsModel.allItems.forEach(function(item){tags.indexOf(item.tag)<0&&item.tag&&tags.push(item.tag)}),itemsModel.tags(tags)}}$.post("./itemtag",{itemName:itemName,oldTag:oldTag,newTag:newTag},function(res,status){setViewModelStatus(swiper.activeIndex)},"json")}}},console.log("tags"+$.fn.tag.globalSettings.tags)});var productPromise;access.products&&(productPromise=new Promise(function(resolve,reject){$.getJSON("./productsJson",function(products,status){resolve(products),productsModel=new ProductsModel(products,swiper),ko.applyBindings(productsModel,$("#products")[0])})}));new Promise(function(resolve,reject){function applyReckoningBindings(orders){reckoningOrdersModel=new OrdersModel(orders,swiper),resolve(reckoningOrdersModel),ko.applyBindings(reckoningOrdersModel,$("#reckoningOrders")[0])}$.getJSON("./reckoningOrdersJson",function(orders,status){access.products?Promise.all([userPromise,productPromise]).then(function(_ref5){var _ref6=_slicedToArray(_ref5,2),user=_ref6[0];applyReckoningBindings(applyProductPrice(_ref6[1],orders,{buyComputing:user.buyComputing,sellComputing:user.sellComputing}))}):applyReckoningBindings(orders)})});$.getJSON("./incomeListJson",function(incomeList,status){incomeListModel=new IncomeListModel(incomeList,swiper),ko.applyBindings(incomeListModel,$("#incomeList")[0])}),access.clients&&$.getJSON("./clientsJson",function(clients,status){clientsModel=new ClientsModel(clients,swiper),ko.applyBindings(clientsModel,$("#clients")[0])});var productNamePromise=new Promise(function(resolve,reject){$.getJSON("./allProductsDropdownJson",function(products,status){resolve(products)})});Promise.all([userPromise,productNamePromise]).then(function(_ref7){var _ref8=_slicedToArray(_ref7,2),user=_ref8[0],products=_ref8[1];$.fn.dropdown.settings.products=products,$.fn.dropdown.settings.productNames=products.map(function(product){return product.name}),$.fn.dropdown.settings.buyComputing=user.buyComputing,$.fn.dropdown.settings.sellComputing=user.sellComputing}),new Promise(function(resolve,reject){$.getJSON("./allClientNamesJson",function(clientNames,status){resolve(clientNames)})}).then(function(clientNames){$.fn.dropdown.settings.clients=clientNames}),$(".swiper-wrapper").on("keydown",function(event){if(13==event.keyCode){var id=$(".swiper-slide")[swiper.activeIndex].id,$target=$("#"+id+" .action-enter");return $target.length>0&&($(document.activeElement).blur(),setTimeout(function(){$target.trigger("click")},100)),!1}}),swiper.params.onSlideChangeStart=function(swiper){switch($(".swiper-slide")[swiper.activeIndex].id){case"receivedOrders":viewModelStatus.receivedOrders&&$.getJSON("./receivedOrdersJson",function(orders,status){ordersModel.setOrders(orders,!0),viewModelStatus.receivedOrders=!1});break;case"purchaseItems":viewModelStatus.purchaseItems&&$.getJSON("./purchaseItemsJson",function(rs,status){itemsModel.setItems(rs.items,!0,!0),viewModelStatus.purchaseItems=!1});break;case"reckoningOrders":viewModelStatus.reckoningOrders&&$.getJSON("./reckoningOrdersJson",function(orders,status){if(access.products)userPromise.then(function(user){var ordersWithPrice=applyProductPrice(productsModel.products,orders,{buyComputing:user.buyComputing,sellComputing:user.sellComputing}),observableOrders=reckoningOrdersModel.getObservableOrders(ordersWithPrice);reckoningOrdersModel.orders(observableOrders)});else{var observableOrders=reckoningOrdersModel.getObservableOrders(orders);reckoningOrdersModel.orders(observableOrders)}viewModelStatus.reckoningOrders=!1});break;case"incomeList":viewModelStatus.incomeList&&$.getJSON("./incomeListJson",function(incomeList,status){incomeListModel.setIncomeList(incomeList),viewModelStatus.incomeList=!1});break;case"clients":viewModelStatus.clients&&$.getJSON("./clientsJson",function(clients,status){clientsModel.setClients(clients),viewModelStatus.clients=!1});break;case"products":viewModelStatus.products&&$.getJSON("./productsJson",function(products,status){productsModel.setProducts(products),viewModelStatus.products=!1})}setTimeout(function(){swiper.update(),$(window).scrollTop(0)},100)}}),require(["angularApp"],function(angularApp){angularApp().bootstrap($("#settings")[0],["settings"]),$(".icon-cog").colorbox({inline:!0,width:335,height:200,scrolling:!1,close:"",top:0,onComplete:function(){setInterval(function(){$.colorbox.resize()},200)},onClosed:function(){userPromise=getUserSetting(),"reckoningOrders"==$(".swiper-slide")[swiper.activeIndex].id&&access.products&&userPromise.then(function(user){$.fn.dropdown.settings.buyComputing=user.buyComputing,$.fn.dropdown.settings.sellComputing=user.sellComputing;var ordersWithPrice=applyProductPrice(productsModel.products,reckoningOrdersModel.orders,{buyComputing:user.buyComputing,sellComputing:user.sellComputing}),observableOrders=reckoningOrdersModel.getObservableOrders(ordersWithPrice);reckoningOrdersModel.orders(observableOrders)})}}),$(window).scroll(function(){var top=$(window).scrollTop();$(".searchbox").css("top",top)})}),$(".icon-signout").bind("click",function(){return $(".mask").addClass("isLoginShow"),$.get("./logout",function(res,status){res.success&&(swiper.destroy(!0,!0),$.get("./content",function(rs,status){setTimeout(function(){$("#container").html(rs),$(".mask").removeClass("isLoginShow")},1e3)},"html"))},"json"),!1})}return run});