<div>
    <button type="button" text="Add" class="icon icon-add" data-bind="click:$root.addOrder">Add Order </button>
</div>
<div class="tmargin-5" data-bind="foreach: orders">
    <section class="order">
        <div class="order-head">
            <input type="hidden" data-bind="value: _id" />
            <input type="text" data-bind="value: client" placeholder="Client Name" />
            <div class="order-savebox">
                <button type="button" text="Add" class="icon icon-save rmargin-20" data-bind="click: submitOrder"> Save Order </button>
                <a href="#" class="icon icon-remove-sign font-white" data-bind="click: $parent.removeOrder"></a>
            </div>
        </div>
        <div class="order-addressbox tmargin-5">
            <div>
                <button type="button" class="icon icon-add" data-bind="click:addAddress"> Add Address</button>
                <!-- ko if: _id() == '' -->
                <button type="button" class="icon icon-address" data-bind="click:getAddresses"> Get Addresses</button>
                <!-- /ko -->
            </div>
            <div class="addresses tmargin-5">
                <!-- ko foreach: addresses -->
                <fieldset class="address">
                    <input type="hidden" data-bind="value: _id" />
                    <input type="hidden" data-bind="value: client" />
                    <input class="w-p40" type="text" data-bind="value: recipient" placeholder="Recipient" />
                    <input class="w-p40" type="text" data-bind="value: phone" placeholder="Phone" />
                    <input class="w-p80" type="text" data-bind="value: address" placeholder="Address" />
                    <div class="address-actions">
                        <a href="#" class="icon icon-remove" data-bind="click: $parent.removeAddress.bind(this,$data)"> </a>
                    </div>
                </fieldset>
                <!-- /ko -->
                <!-- <button type="button" text="Add" data-bind="click:submitAddresses">Submit </button> -->
            </div>
        </div>
        <div class="order-itembox">
            <div>
                <button type="button" text="Add" class="icon icon-add" data-bind="click:addItem"> Add Item</button>
            </div>
            <div class="items tmargin-5">
                <!-- ko foreach: items -->
                <fieldset class="item">
                    <div class="item-fields">
                        <input class="w-p30" type="text" data-bind="value: name" placeholder="Product Name" />
                        <input class="w-p10" type="number" min="0" max="100" step="1" data-bind="value: quantity" placeholder="Quantity" />
                        <input class="w-p20" type="text" data-bind="value: buyPrice" placeholder="Buy Price" />
                        <input class="w-p20" type="text" data-bind="value: sellPrice" placeholder="Sell Price" />
                        <a href="#" class="icon icon-search" data-bind="click: $parent.getHistoricTrades"></a>
                        <div class="item-actions">
                            <a href="#" class="icon icon-remove" data-bind="click: $parent.removeItem"></a>
                        </div>
                    </div>
                    <div class="historicbox tmargin-10" style="display: none">
                        <!-- ko if: $parent.hasHistoricTrades -->
                        <table class="item-historicTrades">
                            <thead>
                                <tr>
                                    <th class="w-p30 taLeft">Client</th>
                                    <th class="w-p10 taLeft">Qua</th>
                                    <th class="w-p20 taLeft">Buy</th>
                                    <th class="w-p20 taLeft">Sell</th>
                                    <th class="w-p20 taRight">Date</th>
                                </tr>
                            </thead>
                            <tbody data-bind="template:{ name: 'historicTrades' , foreach: historicTrades }">
                            </tbody>
                        </table>
                        <!-- /ko -->
                        <!-- ko ifnot: $parent.hasHistoricTrades -->
                        <p class="tmargin-10">we cannot get historic trades!</p>
                        <!-- /ko -->
                    </div>
                </fieldset>
                <!-- /ko -->
            </div>
        </div>
    </section>
</div>
<script type="text/html" id="historicTrades">
    <tr>
        <td class="taLeft">
            <input type="hidden" data-bind="text: name"></input>
            <span data-bind="text: client"></span>
        </td>
        <td class="taLeft">
            <span data-bind="text: quantity"></span>
        </td>
        <td class="taLeft">
            <span data-bind="text: buyPrice"></span>
        </td>
        <td class="taLeft">
            <span data-bind="text: sellPrice"></span>
        </td>
        <td class="taRight">
            <span data-bind="text: createDate"></span>
        </td>
    </tr>
</script>
<script>
var Item = function(item) {
    var self = this;


    self.name = item && item.name ? item.name : '';
    self.quantity = item && item.quantity ? item.quantity : '1';
    self.buyPrice = item && item.buyPrice ? item.buyPrice : '';
    self.sellPrice = item && item.sellPrice ? item.sellPrice : '';
    self.note = item && item.note ? item.note : '';
    self.isDone = item && item.isDone ? item.isDone : false;
    self.historicTrades = ko.observableArray([]);

    self.isHistoricTradesOpen = false;

}

var OrderModel = function(order) {
    var self = this;

    self._id = ko.observable(order ? order._id : '');
    self.client = ko.observable(order ? order.client : '');


    var observableItems = [];

    if (order && $.isArray(order.items) && order.items.length > 0) {
        order.items.forEach(function(item) {
            observableItems.push(new Item(item));
        });

    } else {
        observableItems.push(new Item());
    }


    self.items = ko.observableArray(observableItems);

    self.addresses = ko.observableArray(order ? order.addresses : [{
        _id: '',
        client: order ? order.client : '',
        recipient: '',
        address: '',
        phone: ''
    }]); //to do

    self.createDate = order ? order.createDate : new Date();
    self.status = order ? order.status : 'RECEIVED';

    self.getHistoricTrades = function(item, event) {
        var itemData = ko.mapping.toJS(item);

        var $historicTrades = $(event.target).parent().next('.historicbox');

        if (!item.isHistoricTradesOpen) {

            if (itemData.name == '') return;

            $.getJSON('/historictrades/' + itemData.name, function(res, status) {

                status == 'success' ? item.historicTrades(res) : item.historicTrades([]);

                $historicTrades.slideDown('fast', function() {
                    item.isHistoricTradesOpen = true;
                });

            });

        } else {

            $historicTrades.slideUp('fast', function() {
                item.isHistoricTradesOpen = false;
            });
        }
    };
    self.hasHistoricTrades = function(item) {

        return item.historicTrades().length > 0 ? true : false;

    };

    self.addItem = function() {

        self.items.unshift(new Item());
    };

    self.removeItem = function(item) {
        self.items.remove(item);
    };



    self.addAddress = function(address) {

        self.addresses.unshift({
            _id: "",
            client: self.client(),
            recipient: "",
            address: "",
            phone: ""
        });

    };

    self.getAddresses = function(order) {

        var client = order.client();

        if (client == '') return;


        $.getJSON('/addresses/' + client, function(res, status) {

            status == 'success' ? order.addresses(res) : order.addresses([]);

        });


    };

    var removedAddresses = [];

    self.removeAddress = function(address) {

        if (address._id != '') {

            removedAddresses.push(address._id);

        }

        self.addresses.remove(address);


    };

    self.submitAddresses = function(order) {

        var addressesData = ko.mapping.toJS(order.addresses);


        $.post('/addresses', {
                "client": order.client,
                "addresses": addressesData
            }, function(addresses, status) {

                order.addresses(addresses);
            },
            'json'
        );

        return false;

    };

    self.submitOrder = function(order) {

        console.log('post request....');

        var orderData = $.parseJSON(ko.toJSON(order));

        $.post('/order', orderData, function(data, status) {

                data.items.forEach(function(item) {

                    item.historicTrades = [];

                });

                console.log('get post result');
                ko.mapping.fromJS(data, {}, order);
                //order = new OrderModel(data);
                //order.init(data);


                var addressesData = ko.mapping.toJS(order.addresses);

                for (var i = 0; i < addressesData.length; i++) {
                    addressesData[i].client = order.client();
                }

                $.post('/addresses', {
                        "client": order.client(),
                        "addresses": addressesData,
                        "removedAddresses": removedAddresses
                    }, function(addresses, status) {

                        order.addresses(addresses);
                    },
                    'json'
                );

            },
            'json'
        );

        return false;

    };

};



var OrdersModel = function(orders) {

    var observableOrders = [];

    orders.forEach(function(order) {

        observableOrders.push(new OrderModel(order));

    })

    var self = this;

    self.orders = ko.observableArray(observableOrders);

    self.addOrder = function() {

        var order = new OrderModel();

        self.orders.unshift(order);
    };
    self.removeOrder = function(order) {
        var id = order._id();
        self.orders.remove(order);
        if (id == '') return;

        $.ajax('/order/' + id, {
            success: function(data, status) {

                console.log(data);

            },
            dataType: 'json',
            type: 'DELETE'

        });


    };

};

var ordersModel = new OrdersModel(<%- JSON.stringify(orders) %>);

ko.applyBindings(ordersModel);
</script>
