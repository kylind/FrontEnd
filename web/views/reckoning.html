<div>
    <button type="button" text="Add" data-bind="click:$root.addOrder">Add Order </button>
</div>
<div data-bind="foreach: orders">
    <section>
        <div>
            <div>
                <input type="hidden" data-bind="value: _id" />
                <input type="text" data-bind="value: client" placeholder="Client Name" />
            </div>
            <div class="addresses">
                <button type="button" text="Add" data-bind="click:addAddress">Add +</button>
                <!-- ko foreach: addresses -->
                <fieldset class="address">
                    <input type="hidden" data-bind="value: _id" />
                    <input type="hidden" data-bind="value: client" />
                    <div class="address-fields">
                        <input class="address-recipient" type="text" data-bind="value: recipient" placeholder="Recipient" />
                        <input class="address-phone" type="text" data-bind="value: phone" placeholder="Phone" />
                        <input class="address-address" type="text" data-bind="value: address" placeholder="Address" />
                    </div>
                    <div class="address-actions"><a href="#" class="icon icon-remove"data-bind="click: $parent.removeAddress.bind(this,$data)"> </a></div>
                </fieldset>
                <!-- /ko -->
                <!-- <button type="button" text="Add" data-bind="click:submitAddresses">Submit </button> -->
            </div>
        </div>
        <div>
            <!-- ko foreach: items -->
            <fieldset class="item">
                <div class="item-fields">
                    <input class="item-name" type="text" data-bind="value: name" placeholder="Product Name" />

                    <input class="item-quantity" type="number" min="0" max="100" step="1" data-bind="value: quantity" placeholder="Quantity" />

                    <input class="item-buy" type="text" data-bind="value: buyPrice" placeholder="Buy Price" />
                    <input class="item-sell" type="text" data-bind="value: sellPrice" placeholder="Sell Price" />
                    <a href="#" class="icon icon-search" data-bind="click: $parent.getHistoricTrades"></a>
                </div>
                <div class="item-actions"><a href="#" class="icon icon-remove" data-bind="click: $parent.removeItem"></a></div>

                <div class="historictrades" style="display: none">
                    <!-- ko if: $parent.getTemplateName -->
                    <h4> Historic Trades </h4>
                    <div data-bind="template:{ name: 'historicTrades' , foreach: historicTrades }">
                    </div>
                    <!-- /ko -->
                    <!-- ko ifnot: $parent.getTemplateName -->
                    <p>we cannot get historic trades!</p>
                    <!-- /ko -->
                </div>
            </fieldset>
            <!-- /ko -->
            <button type="button" text="Add" data-bind="click:addItem">Add </button>
        </div>
        <div>
            <button type="button" text="Add" data-bind="click: submitOrder">Submit </button>
        </div>
    </section>
</div>
<script type="text/html" id="historicTrades">
    <section>
        <span data-bind="text: client"></span>
        <span data-bind="text: name"></span>
        <span data-bind="text: quantity"></span>
        <span data-bind="text: buyPrice"></span>
        <span data-bind="text: sellPrice"></span>
        <span data-bind="text: createDate"></span>
    </section>
</script>
<script>
var Item = function(item) {
    var self = this;


    self.name = item && item.name ? item.name : '';
    self.quantity = item && item.quantity ? item.quantity : '1';
    self.buyPrice = item && item.buyPrice ? item.buyPrice : '';
    self.sellPrice = item && item.sellPrice ? item.sellPrice : '';
    self.note = item && item.note ? item.note : '';
    self.isDone = item && item.isDone ? item.isDone : false;
    self.historicTrades = ko.observableArray([]);

    self.isHistoricTradesOpen = false;

}

var OrderModel = function(order) {
    var self = this;




    self._id = ko.observable(order ? order._id : '');
    self.client = ko.observable(order ? order.client : '');


    var observableItems = [];

    if (order && $.isArray(order.items) && order.items.length > 0) {
        order.items.forEach(function(item) {
            observableItems.push(new Item(item));
        });

    } else {
        observableItems.push(new Item());
    }



    self.items = ko.observableArray(observableItems);

    self.addresses = ko.observableArray(order ? order.addresses : [{
        _id: '',
        client: order ? order.client : '',
        recipient: '',
        address: '',
        phone: ''
    }]); //to do

    self.createDate = order ? order.createDate : new Date();
    self.status = order ? order.status : 'RECEIVED';

    self.getHistoricTrades = function(item, event) {
        var itemData = ko.mapping.toJS(item);

        var $historicTrades = $(event.target).parent().next('.historictrades');

        if (!item.isHistoricTradesOpen) {
            $.getJSON('/historictrades/' + itemData.name, function(res, status) {

                status == 'success' ? item.historicTrades(res) : item.historicTrades([]);

                $historicTrades.slideDown('fast', function() {
                    item.isHistoricTradesOpen = true;
                });

            });

        } else {

            $historicTrades.slideUp('fast', function() {
                item.isHistoricTradesOpen = false;
            });
        }
    };
    self.getTemplateName = function(item) {

        return item.historicTrades().length > 0 ? true : false;

    };

    self.addItem = function() {

        self.items.push(new Item());
    };

    self.removeItem = function(item) {
        self.items.remove(item);
    };



    self.addAddress = function(address) {

        self.addresses.push({
            _id: "",
            client: self.client(),
            recipient: "",
            address: "",
            phone: ""
        });

    };

    self.removeAddress = function(address) {

        self.addresses.remove(address);

    };

    self.submitAddresses = function(order) {

        var addressesData = ko.mapping.toJS(order.addresses);


        $.post('/addresses', {
                "client": order.client,
                "addresses": addressesData
            }, function(addresses, status) {

                order.addresses(addresses);
            },
            'json'
        );

        return false;

    };

    self.submitOrder = function(order) {

        console.log('post request....');

        var orderData = $.parseJSON(ko.toJSON(order));

        $.post('/order', orderData, function(data, status) {

                data.items.forEach(function(item) {

                    item.historicTrades = [];

                });

                console.log('get post result');
                ko.mapping.fromJS(data, {}, order);
                //order = new OrderModel(data);
                //order.init(data);


                var addressesData = ko.mapping.toJS(order.addresses);

                for (var i = 0; i < addressesData.length; i++) {
                    addressesData[i].client = order.client();
                }

                $.post('/addresses', {
                        "client": order.client(),
                        "addresses": addressesData
                    }, function(addresses, status) {

                        order.addresses(addresses);
                    },
                    'json'
                );

            },
            'json'
        );

        return false;

    };

};



var OrdersModel = function(orders) {

    var observableOrders = [];

    orders.forEach(function(order) {

        observableOrders.push(new OrderModel(order));

    })

    var self = this;

    self.orders = ko.observableArray(observableOrders);

    self.addOrder = function(data) {

        var order = new OrderModel();

        self.orders.push(order);
    };
};

var ordersModel = new OrdersModel(<%- JSON.stringify(orders) %>);

ko.applyBindings(ordersModel);
</script>
