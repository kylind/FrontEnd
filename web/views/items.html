<div>
    <span>
            Product Name
        </span>
    <span>
            Quantity
        </span>
</div>
<div data-bind="foreach: items">
    <section>
        name: <span data-bind="text: _id"></span> quantity:
        <span data-bind="text: quantity"></span> purchaseDetail:
        <!-- ko foreach: purchaseDetail -->
        <span data-bind="text: $root.getSubName($data)"></span><span data-bind="name: $root.getSubName($data), text: quantity"></span>
        <!-- /ko -->
        <button data-bind="click: $root.markDone">MarkDone</button>
        <button data-bind="click: $root.getSubItems">ItemDetail</button>
        <div class="subItem" style="display: none">
            <h4> Sub Items </h4>
            <div data-bind="template:{ name: getTemplateName, foreach: subItems }">
            </div>
        </div>
    </section>
</div>
<script type="text/html" id="subItem">
    <section>
        <span data-bind="text: _id"></span>
        <span data-bind="text: client"></span>
        <span data-bind="text: name"></span>
        <span data-bind="text: quantity"></span>
        <span data-bind="text: note"></span>
        <span data-bind="text: isDone"></span>
        <span data-bind="text: new Date(createDate).toLocaleDateString()"></span>
        <button data-bind="click: $parent.markDone">MarkDone</button>
    </section>
</script>
<script type="text/html" id="errorInfo">
    <p>Somehow we cannot get item detail for now!</p>
</script>
<script>
var Item = function(item) {
    var self = this;
    self._id = ko.observable(item ? item._id : '');
    self.quantity = ko.observable(item ? item.quantity : '');
    self.purchaseDetail = ko.observableArray(item ? item.purchaseDetail : [{
        isDone: false,
        quantity: 0
    }]);

    self.subItems = ko.observableArray([]);

    self.getTemplateName = function(subItem) {

        return self.subItems().length > 0 ? 'subItem' : 'errorInfo';

    };

    self.displaySubItems = ko.computed(function() {

        return self.subItems().length > 0;

    });

    self.markDone = function(){

    }

    self.isSubItemsOpen = false;

};

var ItemsModel = function(items) {

    var observableItems = [];

    items.forEach(function(item) {

        observableItems.push(new Item(item));

    })



    var self = this;

    self.items = ko.observableArray(observableItems);

    self.getSubName = function(item) {

        return 'item' + item.isDone;

    };

    self.getSubItems = function(item, event) {

        var itemData = ko.mapping.toJS(item);

        if (!item.isSubItemsOpen) {
            $.getJSON('/subitems/' + itemData._id, function(res, status) {

                if (status == 'success') {
                    item.subItems(res);

                } else {
                    item.subItems([]);
                }

                $(event.target).next('.subItem').slideDown('fast',function(){
                     item.isSubItemsOpen=true;
                });

            });

        }else{

            $(event.target).next('.subItem').slideUp('fast',function(){
                item.isSubItemsOpen=false;
            });


        }



    };

    self.markDone = function(item) {

        var itemData = ko.mapping.toJS(item);

        var isPurchased = true;


        itemData.purchaseDetail.forEach(function(item) {

            if (!item.isDone) {
                isPurchased = false;
            }

        });

        $.post('/item/' + itemData._id, {
                isDone: !isPurchased
            }, function(res, status) {

                item.purchaseDetail(res.purchaseDetail);
            },
            'json'
        );

    };

}

var items = <%- JSON.stringify(items) %>;

var itemsModel = new ItemsModel(items);


//ko.mapping.fromJS(items, {}, itemsModel);

ko.applyBindings(itemsModel);
</script>
