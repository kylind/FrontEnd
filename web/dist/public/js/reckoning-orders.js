"use strict";define(["jquery","knockout","knockout.mapping"],function(e,r,s){function t(){var e=Date.now(),r=(new Date).getDay(),s=e-24*(r+7)*60*60*1e3,t=new Date(new Date(s).setHours(0,0,0,0));return t}r.mapping=s;var i=function(e){var s=this;s.name=r.observable(e&&e.name?e.name:""),s.quantity=r.observable(e&&e.quantity?e.quantity:"1"),s.buyPrice=r.observable(e&&!isNaN(e.buyPrice)?e.buyPrice:""),s.sellPrice=r.observable(e&&!isNaN(e.sellPrice)?e.sellPrice:""),s.profit=e&&e.profit?e.profit:"",s.note=e&&e.note?e.note:"",s.isDone=!(!e||!e.isDone)&&e.isDone,s.historicTrades=r.observableArray([]),s.isHistoricTradesOpen=!1,s.isChanged=!1,s.name.subscribe(function(e){s.isChanged=!0}),s.quantity.subscribe(function(e){s.isChanged=!0}),s.buyPrice.subscribe(function(e){s.isChanged=!0}),s.sellPrice.subscribe(function(e){s.isChanged=!0})},n=function(s,n){var a=this,o=t();a._id=r.observable(s?s._id:""),a.client=r.observable(s?s.client:""),a.postage=r.observable(s&&s.postage?s.postage:0);var u=[];if(s&&e.isArray(s.items)&&s.items.length>0)s.items.forEach(function(e){u.push(new i(e))});else for(var c=0;c<3;c++)u.push(new i);a.isChanged=!1,a.items=r.observableArray(u),a.items.subscribe(function(e){a.isChanged=!0}),a.client.subscribe(function(e){a.isChanged=!0}),a.postage.subscribe(function(e){a.isChanged=!0}),a.createDate=r.observable(s?s.createDate:""),a.displayDate=r.observable(s?s.displayDate:""),a.rate=s?s.rate:"",a.buyPrice=r.observable(s&&s.buyPrice?s.buyPrice:""),a.sellPrice=r.observable(s&&s.sellPrice?s.sellPrice:""),a.profit=r.observable(s&&s.profit?s.profit:""),a.isComplete=r.observable(!(!s||!s.isComplete)&&s.isComplete),a.formatPrice=function(e){if(!e)return"?";var r=e();return r?(+r).toFixed(1):"?"},a.total=r.pureComputed(function(){var e=parseFloat(this.sellPrice()),r=parseFloat(this.postage());return isNaN(e)||isNaN(r)?"?":(e+r).toFixed(1)},a);a.status=r.observable(s?s.status:"1RECEIVED"),a.packingStatus=s?s.packingStatus:"1ISREADY",a.orderStatus=r.pureComputed(function(){return"3DONE"==a.status()?"font-green":"2SENT"==a.status()?"font-yellow":void 0}),a.getHistoricTrades=function(s,t,i){var a=r.mapping.toJS(s),o=e(i.target).closest(".item").find(".historicbox");if(s.isHistoricTradesOpen)o.slideUp("fast",function(){s.isHistoricTradesOpen=!1,n.update()});else{var u=arguments[4];if(""==a.name)return;arguments[3](),e.getJSON("./historictrades",{itemName:a.name},function(e,r){"success"==r?s.historicTrades(e):s.historicTrades([]),o.slideDown("fast",function(){s.isHistoricTradesOpen=!0,u()})})}},a.hasHistoricTrades=function(e){return e.historicTrades().length>0},a.addItem=function(){a.items.unshift(new i),n.update()},a.removeItem=function(e){a.items.remove(e),n.update()},a.addAddress=function(e){a.addresses.unshift({_id:"",client:a.client(),recipient:"",address:"",phone:""}),n.update()},a.getAddresses=function(r){arguments[3]();var s=arguments[4],t=r.client();""!=t&&e.getJSON("./addressesByClient",{client:t},function(e,t){"success"==t?r.addresses(e):r.addresses([]),s()})};var d=[];a.removeAddress=function(e){""!=e._id&&d.push(e._id),a.addresses.remove(e),n.update()},a.submitAddresses=function(s){arguments[3]();var t=arguments[4],i=r.mapping.toJS(s.addresses);return e.post("./addresses",{client:s.client,addresses:i},function(e,r){s.addresses(e),t()},"json"),!1},a.markDone=function(){arguments[3]();var r=arguments[4],s=arguments[1],t=a._id(),i=a.status(),n="1RECEIVED";"1RECEIVED"==i?n="2SENT":"2SENT"==i&&(n="3DONE"),e.ajax("./orderStatus/"+t,{success:function(t,u){if(a.status(n),""==e("#search-reckoningOrders").val()){"3DONE"==n&&a.createDate()<o?s.removeDoneOrder(a):"3DONE"==i&&a.createDate()<o&&s.addExistingOrder(a);var c=s.orders();s.sortOrders(c),s.orders(c)}r(!0)},data:{status:n},dataType:"json",type:"PUT"})},a.submitOrder=function(s){arguments[3]();var t=(arguments[4],e.parseJSON(r.toJSON(s)));return e.post("./order",t,function(e,t){e.items.forEach(function(e){e.historicTrades=[]}),console.log("get post result"),r.mapping.fromJS(e,{},s)},"json"),!1}},a=function(s,t){function a(e){l=e}function o(e){var r=l.filter(function(r){return r.client().indexOf(e)>=0});c.orders(r),setTimeout(function(){t.update()},100)}function u(r){p=r;var s=setTimeout(function(){for(var r=1;r<f.length;r++)clearTimeout(f[r]);f=[],""!=p&&e.ajax("./ordersByName",{data:{client:p},type:"GET",success:function(e,r){c.orders(c.getObservableOrders(e)),setTimeout(function(){t.update()},100)},dataType:"json"}),console.log("i am searching "+p)},1e3);f.push(s)}var c=this;c.sortOrders=function(e){e.sort(function(e,r){var s=e.status(),t=r.status();return s==t?e.createDate()<=r.createDate()?1:-1:s<t?-1:1})},c.getObservableOrders=function(e){var r=[];return e.forEach(function(e){r.push(new n(e,t))}),r};var d=c.getObservableOrders(s);c.orders=r.observableArray(d),c.toggleClientView=function(r,s,i){e(i.target).toggleClass("icon-eyeslash");var n=e(".orders--reckoning");e(i.target).hasClass("icon-eyeslash")?n.addClass("isClientView"):n.removeClass("isClientView"),t.update()},c.submitOrders=function(){arguments[3]();var s=arguments[4],t=c.orders(),n=e.parseJSON(r.toJSON(t));if(Array.isArray(n)&&n.length>0){var a=[],o=n.filter(function(e,r){var s=!1;if(e.isChanged)s=!0;else for(var t=0;t<e.items.length;t++)if(e.items[t].isChanged){s=!0;break}return s&&a.push(r),s});o.length>0?e.post("/orders",{orders:o},function(n,o){n.forEach(function(s,n){var o=a[n];e.isArray(s.items)&&0==s.items.length&&(s.items=[{},{},{}]),s.items.forEach(function(e){e.historicTrades=[]}),r.mapping.fromJS(s,{items:{create:function(e){return new i(e.data)}}},t[o]),t[o].isChanged=!1}),s(!0)},"json"):s()}return!1},c.addOrder=function(){a();var r=new n(null,t);c.orders.unshift(r),a(c.orders()),t.update(),e(window).scrollTop(0)},c.addExistingOrder=function(e){c.orders.push(doneOrder),a(c.orders())},c.removeDoneOrder=function(e){c.orders.remove(e),a(c.orders())},c.removeOrder=function(r){arguments[3]();var s=arguments[4],i=r._id();return c.orders.remove(r),""==i?void s():(e.ajax("./order/"+i,{success:function(e,r){s(!0)},dataType:"json",type:"DELETE"}),a(c.orders()),void t.update())};var l=null;c.searchOrders=function(r,s){var i=e(s.target).val(),n=/(\s*)([\u4E00-\u9FA5\uF900-\uFA2D\w]+[\u4E00-\u9FA5\uF900-\uFA2D\w ]*)/,a=i.match(n);null==l&&(l=c.orders()),null==a&&(c.sortOrders(l),c.orders(l)),null!=a?""==a[1]?o(a[2]):u(a[2]):null!=l&&(p="",c.orders(l),setTimeout(function(){t.update()},100))};var f=[],p=""};return a});
//# sourceMappingURL=reckoning-orders.js.map
