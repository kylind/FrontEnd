"use strict";define(["jquery","knockout","knockout.mapping"],function(e,r,s){function t(){var e=Date.now(),r=(new Date).getDay(),s=e-24*(r+7)*60*60*1e3,t=new Date(new Date(s).setHours(0,0,0,0));return t}r.mapping=s;var n=function(e){var s=this;s.name=r.observable(e&&e.name?e.name:""),s.quantity=r.observable(e&&e.quantity?e.quantity:"1"),s.buyPrice=r.observable(e&&!isNaN(e.buyPrice)?e.buyPrice:""),s.sellPrice=r.observable(e&&!isNaN(e.sellPrice)?e.sellPrice:""),s.profit=e&&e.profit?e.profit:"",s.note=e&&e.note?e.note:"",s.isDone=!(!e||!e.isDone)&&e.isDone,s.tag=e&&e.tag?e.tag:"",s.historicTrades=r.observableArray([]),s.isHistoricTradesOpen=!1,s.isChanged=!1,s.name.subscribe(function(e){s.isChanged=!0}),s.quantity.subscribe(function(e){s.isChanged=!0}),s.buyPrice.subscribe(function(e){s.isChanged=!0}),s.sellPrice.subscribe(function(e){s.isChanged=!0})},i=function(s,t){var i=this;i._id=r.observable(s?s._id:""),i.client=r.observable(s?s.client:""),i.postage=r.observable(s&&s.postage?s.postage:0);var a=[];if(s&&e.isArray(s.items)&&s.items.length>0)s.items.forEach(function(e){a.push(new n(e))});else for(var o=0;o<3;o++)a.push(new n);i.isChanged=!1,i.items=r.observableArray(a),i.items.subscribe(function(e){i.isChanged=!0}),i.client.subscribe(function(e){i.isChanged=!0}),i.postage.subscribe(function(e){i.isChanged=!0}),i.createDate=r.observable(s?s.createDate:""),i.displayDate=r.observable(s?s.displayDate:""),i.rate=s?s.rate:"",i.buyPrice=r.observable(s&&s.buyPrice?s.buyPrice:""),i.sellPrice=r.observable(s&&s.sellPrice?s.sellPrice:""),i.profit=r.observable(s&&s.profit?s.profit:""),i.isComplete=r.observable(!(!s||!s.isComplete)&&s.isComplete),i.formatPrice=function(e){if(!e)return"?";var r=e();return r?(+r).toFixed(1):"?"},i.total=r.pureComputed(function(){var e=parseFloat(this.sellPrice()),r=parseFloat(this.postage());return isNaN(e)||isNaN(r)?"?":(e+r).toFixed(1)},i);i.status=r.observable(s?s.status:"1RECEIVED"),i.packingStatus=s?s.packingStatus:"1ISREADY",i.orderStatus=r.pureComputed(function(){return"3DONE"==i.status()?"font-green":"2SENT"==i.status()?"font-yellow":void 0}),i.getHistoricTrades=function(s,n,i){var a=r.mapping.toJS(s),o=e(i.target).closest(".item").find(".historicbox");if(s.isHistoricTradesOpen)o.slideUp("fast",function(){s.isHistoricTradesOpen=!1,t.update()});else{var u=arguments[4];if(""==a.name)return;arguments[3](),e.getJSON("./historictrades",{itemName:a.name},function(e,r){"success"==r?s.historicTrades(e):s.historicTrades([]),o.slideDown("fast",function(){s.isHistoricTradesOpen=!0,u()})})}},i.hasHistoricTrades=function(e){return e.historicTrades().length>0},i.addItem=function(){i.items.unshift(new n),t.update()},i.removeItem=function(e){i.items.remove(e),t.update()},i.addAddress=function(e){i.addresses.unshift({_id:"",client:i.client(),recipient:"",address:"",phone:""}),t.update()},i.getAddresses=function(r){arguments[3]();var s=arguments[4],t=r.client();""!=t&&e.getJSON("./addressesByClient",{client:t},function(e,t){"success"==t?r.addresses(e):r.addresses([]),s()})};var u=[];i.removeAddress=function(e){""!=e._id&&u.push(e._id),i.addresses.remove(e),t.update()},i.submitAddresses=function(s){arguments[3]();var t=arguments[4],n=r.mapping.toJS(s.addresses);return e.post("./addresses",{client:s.client,addresses:n},function(e,r){s.addresses(e),t()},"json"),!1},i.submitOrder=function(s){arguments[3]();var t=(arguments[4],e.parseJSON(r.toJSON(s)));return e.post("./order",t,function(e,t){e.items.forEach(function(e){e.historicTrades=[]}),console.log("get post result"),r.mapping.fromJS(e,{},s)},"json"),!1}},a=function(s,a){function o(e){var r=f.filter(function(r){return r.client().indexOf(e)>=0});d.orders(r),setTimeout(function(){a.update()},100)}function u(r){b=r;var s=setTimeout(function(){for(var r=1;r<v.length;r++)clearTimeout(v[r]);v=[],""!=b&&e.ajax("./ordersByName",{data:{client:b},type:"GET",success:function(e,r){d.orders(d.getObservableOrders(e)),setTimeout(function(){a.update()},100)},dataType:"json"}),console.log("i am searching "+b)},1e3);v.push(s)}var d=this,c=t();d.updateReservedOrders=function(e){f=e},d.sortOrders=function(e){e.sort(function(e,r){var s=e.status(),t=r.status();return s==t?e.createDate()<=r.createDate()?1:-1:s<t?-1:1})},d.getObservableOrders=function(e){var r=[];return e.forEach(function(e){r.push(new i(e,a))}),r};var l=d.getObservableOrders(s);d.orders=r.observableArray(l),d.toggleClientView=function(r,s,t){e(t.target).toggleClass("icon-eyeslash");var n=e(".orders--reckoning");e(t.target).hasClass("icon-eyeslash")?n.addClass("isClientView"):n.removeClass("isClientView"),a.update()},d.markDone=function(r){arguments[3]();var s=arguments[4],t=(arguments[1],r._id()),n=r.status(),i="1RECEIVED";"1RECEIVED"==n?i="2SENT":"2SENT"==n&&(i="3DONE"),e.ajax("./orderStatus/"+t,{success:function(t,n){r.status(i);var a=d.orders();""==e("#search-reckoningOrders").val()?("3DONE"==i&&r.createDate()<c&&d.removeDoneOrder(r),d.sortOrders(a),d.orders(a),d.updateReservedOrders(a)):p=!0,s(!0)},data:{status:i},dataType:"json",type:"PUT"})},d.submitOrders=function(){arguments[3]();var s=arguments[4],t=d.orders(),i=e.parseJSON(r.toJSON(t));if(Array.isArray(i)&&i.length>0){var a=[],o=i.filter(function(e,r){var s=!1;if(e.isChanged)s=!0;else for(var t=0;t<e.items.length;t++)if(e.items[t].isChanged){s=!0;break}return s&&a.push(r),s});o.length>0?e.post("/orders",{orders:o},function(i,o){i.forEach(function(s,i){var o=a[i];e.isArray(s.items)&&0==s.items.length&&(s.items=[{},{},{}]),s.items.forEach(function(e){e.historicTrades=[]}),r.mapping.fromJS(s,{items:{create:function(e){return new n(e.data)}}},t[o]),t[o].isChanged=!1}),s(!0)},"json"):s()}return""!=e("#search-reckoningOrders").val()&&(p=!0),!1},d.addOrder=function(){var r=new i(null,a);d.orders.unshift(r),d.updateReservedOrders(d.orders()),a.update(),e(window).scrollTop(0)},d.addExistingOrder=function(e){d.orders.push(doneOrder)},d.removeDoneOrder=function(e){d.orders.remove(e)},d.removeOrder=function(r){arguments[3]();var s=arguments[4],t=r._id();return d.orders.remove(r),""==t?void s():(e.ajax("./order/"+t,{success:function(e,r){s(!0)},dataType:"json",type:"DELETE"}),d.updateReservedOrders(d.orders()),void a.update())};var f=null,p=!1;d.searchOrders=function(r,s){var t=e(s.target).val(),n=/(\s*)([\u4E00-\u9FA5\uF900-\uFA2D\w]+[\u4E00-\u9FA5\uF900-\uFA2D\w ]*)/,i=t.match(n);null==f&&(f=d.orders()),null!=i?""==i[1]?o(i[2]):u(i[2]):p?e.getJSON("./reckoningOrdersJson",function(e,r){var s=d.getObservableOrders(e);f=s,p=!1,d.orders(s),setTimeout(function(){a.update()},100)}):null!=f&&(b="",d.sortOrders(f),d.orders(f),setTimeout(function(){a.update()},100))};var v=[],b=""};return a});
//# sourceMappingURL=reckoning-orders.js.map
