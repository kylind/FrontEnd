{"version":3,"sources":["public/js/purchase-items.js"],"names":["define","$","ko","mapping","SubItem","subItem","self","this","_id","client","note","quantity","isDone","synchronizePurchaseDetail","allItems","markDone","findIndex","parent","event","_item","tag","itemData","index","toJS","item","Item","swiper","observable","purchaseDetail","subItems","observableArray","updateSubItems","newSubItems","Array","isArray","length","forEach","push","hasItemDetail","restCount","pureComputed","notDone","displaySubItems","arguments","post","itemName","isPurchased","status","flagColor","itemTag","succeed","res","markItemStatus","subItemData","markSubItemDone","root","getSubName","getJSON","isSubItemsOpen","getSubItems","MarkedItem","target","parents","next","slideUp","update","name","detail","slideDown","ItemsModel","items","convertPurchaseStatus","compareStatus","itemB","compareTag","itemA","init","observableItems","tags","statusNumberB","statusNumberA","isAll","needRefreshTag","orderBy","currentItems","needBinding","setTimeout","sort","indexOf","filterItems","addClass","_init","_init2","_slicedToArray","$currentTag","setItems","map","specificItems","refreshItems","sortfield","$currentTab","hasClass","filter","text","_init3","_init4","$previousTag","removeClass","document","click"],"mappings":"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","file":"purchase-items.js","sourcesContent":["define(['jquery', 'knockout', 'knockout.mapping'], function($, ko, mapping) {\n\n    ko.mapping = mapping;\n\n    var SubItem = function(subItem) {\n        var self = this;\n        self._id = subItem._id;\n        self.client = subItem.client;\n        self.name = subItem.name;\n        self.note = subItem.note;\n        self.quantity = subItem.quantity;\n        self.isDone = ko.observable(subItem.isDone);\n\n    }\n    var Item = function(item, swiper) {\n        var self = this;\n        self._id = item ? item._id : '';\n        self.quantity = item ? item.quantity : '';\n        self.tag = ko.observable((item && item.tag) ? item.tag : '');\n        self.purchaseDetail = ko.observableArray(item ? item.purchaseDetail : []);\n\n\n\n        self.subItems = ko.observableArray([]);\n\n\n        self.updateSubItems = function(subItems) {\n\n            var newSubItems = [];\n\n            if (Array.isArray(subItems) && subItems.length > 0) {\n                subItems.forEach(function(_item) {\n                    newSubItems.push(new SubItem(_item));\n                })\n\n            }\n\n            self.subItems(newSubItems);\n\n        }\n\n        self.hasItemDetail = function(subItem) {\n\n            return self.subItems().length > 0 ? true : false;\n\n        };\n\n        self.restCount = ko.pureComputed(function() {\n\n            var purchaseDetail = self.purchaseDetail();\n\n            var isDone = 0,\n                notDone = 0;\n\n            purchaseDetail.forEach(function(item) {\n                if (item.isDone) {\n                    isDone = item.quantity;\n\n                } else {\n                    notDone = item.quantity;\n\n                }\n\n            })\n            if (isDone < self.quantity && isDone != 0) {\n\n                return self.quantity - isDone;\n\n            } else {\n\n                return '';\n            }\n\n        });\n\n        self.displaySubItems = ko.pureComputed(function() {\n\n            return self.subItems().length > 0;\n\n        });\n\n        function synchronizePurchaseDetail(allItems) {\n            var index = allItems.findIndex(function(_item) {\n                return _item._id == self._id && _item.tag == self.tag();\n\n            })\n\n            if (index > -1) {\n                allItems[index] = ko.mapping.toJS(self);\n            }\n\n\n\n        }\n\n        self.markDone = function(item, parent, event) {\n\n            arguments[3]();\n            var succeed = arguments[4];\n\n            var itemData = ko.mapping.toJS(item);\n\n            var isPurchased = true;\n\n\n            itemData.purchaseDetail.forEach(function(item) {\n\n                if (!item.isDone) {\n                    isPurchased = false;\n                }\n\n            });\n\n            $.post('./item', {\n                    itemTag: itemData.tag,\n                    itemName: itemData._id,\n                    isDone: !isPurchased\n                }, function(res, status) {\n\n                    item.purchaseDetail(res.purchaseDetail);\n                    synchronizePurchaseDetail(parent.allItems);\n\n                    var flagColor = (!isPurchased) ? \"font-green\" : \"\";\n\n                    if (self.displaySubItems) {\n\n                        self.subItems().forEach(function(_item) {\n                            _item.isDone(!isPurchased);\n                        })\n                    }\n                    succeed();\n                },\n                'json'\n            );\n\n        };\n\n        self.markItemStatus = function() {\n\n            var purchaseDetail = self.purchaseDetail();\n\n            var isDone = 0,\n                notDone = 0;\n\n            purchaseDetail.forEach(function(item) {\n                if (item.isDone) {\n                    isDone = item.quantity;\n\n                } else {\n                    notDone = item.quantity;\n\n                }\n\n            })\n\n            if (notDone == self.quantity) {\n                return '';\n            } else if (isDone == self.quantity) {\n                return 'font-green';\n            } else {\n                return 'font-yellow';\n            }\n\n        }\n\n        self.markSubItemDone = function(subItem, parent, event) {\n\n            arguments[3]();\n            var succeed = arguments[4];\n            var root=arguments[5];\n\n            var subItemData = ko.mapping.toJS(subItem);\n            subItemData.isDone = !subItemData.isDone;\n            subItemData.tag = parent.tag();\n\n\n\n            $.post('./subitem', subItemData, function(res, status) {\n\n                    subItem.isDone(!subItem.isDone());\n\n                    //$(event.target).toggleClass('font-green');\n\n                    self.purchaseDetail(res.purchaseDetail);\n                    synchronizePurchaseDetail(root.allItems);\n\n                    self.subItems().forEach(function(_item) {\n                        if (_item.client == subItem.client) {\n                            _item.isDone(subItem.isDone());\n                        }\n                    });\n                    succeed();\n\n                },\n                'json'\n            );\n\n        }\n\n\n        self.getSubName = function(item) {\n\n            return 'item' + item.isDone;\n\n        };\n\n        self.getSubItems = function(item, parent, event) {\n\n\n            var itemData = ko.mapping.toJS(item);\n\n            if (!item.isSubItemsOpen) {\n                arguments[3]();\n                var succeed = arguments[4]\n                $.getJSON('./subitems', { itemName: itemData._id, itemTag: itemData.tag }, function(res, status) {\n\n                    if (status == 'success') {\n\n                        //item.subItems(res);\n\n                        self.updateSubItems(res);\n\n                    } else {\n                        item.subItems([]);\n                    }\n\n                    $(event.target).parents('.orderitem-cnt').next().slideDown('fast', function() {\n                        item.isSubItemsOpen = true;\n                        succeed();\n                    });\n\n                });\n\n            } else {\n\n                $(event.target).parents('.orderitem-cnt').next().slideUp('fast', function() {\n                    item.isSubItemsOpen = false;\n                    swiper.update();\n                });\n\n\n            }\n\n\n\n        };\n\n        self.isSubItemsOpen = false;\n\n    };\n\n\n    var MarkedItem = function(item) {\n\n        var self = this;\n        self.name = item ? item.name : '';\n        self.note = item ? item.note : '';\n        self.quantity = item ? item.quantity : '';\n\n    };\n\n    var ItemsModel = function(items, swiper) {\n\n        function convertPurchaseStatus(item) {\n\n            var detail = typeof item.purchaseDetail == 'function' ? item.purchaseDetail() : item.purchaseDetail;\n\n            var isDone = 0,\n                notDone = 0;\n\n            detail.forEach(function(_item) {\n                if (_item.isDone) {\n                    isDone = _item.quantity;\n\n                } else {\n                    notDone = _item.quantity;\n\n                }\n\n            })\n\n            if (notDone == item.quantity) {\n                return -1;\n            } else if (isDone == item.quantity) {\n                return 1;\n            } else {\n                return 0\n            }\n        }\n\n        function compareTag(itemA, itemB) {\n\n            if (!itemA.tag) {\n                return -1;\n            } else if (!itemB.tag) {\n                return 1;\n            } else {\n                if (itemA.tag < itemB.tag) {\n                    return -1;\n                } else if (itemA.tag > itemB.tag) {\n                    return 1;\n                } else {\n                    var statusNumberA = convertPurchaseStatus(itemA);\n                    var statusNumberB = convertPurchaseStatus(itemB);\n\n                    if (statusNumberA < statusNumberB) {\n                        return -1;\n                    } else if (statusNumberA > statusNumberB) {\n                        return 1;\n                    } else {\n                        return 0;\n                    }\n                }\n            }\n\n        }\n\n        function compareStatus(itemA, itemB) {\n\n            var statusNumberA = convertPurchaseStatus(itemA);\n            var statusNumberB = convertPurchaseStatus(itemB);\n\n            if (statusNumberA < statusNumberB) {\n                return -1;\n            } else if (statusNumberA > statusNumberB) {\n                return 1;\n            } else {\n                if (!itemA.tag) {\n                    return -1;\n                } else if (!itemB.tag) {\n                    return 1;\n                } else {\n\n                    if (itemA.tag < itemB.tag) {\n                        return -1;\n                    } else if (itemA.tag > itemB.tag) {\n                        return 1;\n                    } else {\n                        return 0;\n                    }\n\n                }\n\n            }\n        }\n\n\n        function init(items, needRefreshTag, orderBy) {\n            var observableItems = [];\n            var tags = [];\n\n\n\n            if (Array.isArray(items) && items.length > 0) {\n\n\n                if (orderBy == 'status') {\n                    items.sort(compareStatus)\n                } else {\n                    items.sort(compareTag)\n                }\n\n                items.forEach(function(item) {\n\n                    observableItems.push(new Item(item, swiper));\n\n                    if (needRefreshTag) {\n                        if (tags.indexOf(item.tag) < 0 && item.tag) {\n                            tags.push(item.tag);\n                        }\n                    }\n\n                })\n\n            }\n\n\n            return [observableItems, tags];\n        }\n\n        var self = this;\n\n        self.allItems = [];\n\n        self.tags = ko.observableArray();\n\n        self.items = ko.observableArray();\n\n\n        self.setItems = function(items, isAll, needBinding) {\n\n            var needRefreshTag=false;\n\n            if (isAll) {\n                $('.link-tag.all').addClass('isActive');\n                needRefreshTag = true;\n            }\n\n\n            var [items, tags] = init(items, needRefreshTag);\n\n            self.items(items);\n\n            if (isAll) {\n                self.tags(tags);\n                self.allItems = self.items().map(function(item) {\n                    return ko.mapping.toJS(item);\n                });\n            }\n\n            if (needBinding) {\n                setTimeout(function() {\n                    $('.hidden-tag').tag();\n\n                }, 10);\n            }\n\n            setTimeout(function() {\n                swiper.update();\n            }, 100);\n\n        }\n\n        self.setItems(items, true, false);\n\n\n\n        self.refreshItems = function(sortfield) {\n\n            var currentItems = self.items().map(function(item) {\n                return ko.mapping.toJS(item);\n\n            })\n            var $currentTab=$('.link-tag.isActive')\n\n            if(!$currentTab.hasClass('all')){\n                currentItems=currentItems.filter(function(item){\n                    return item.tag==$currentTab.text();\n\n                })\n\n            }\n\n            var [items, tags] = init(currentItems, false, sortfield);\n\n            self.items(items);\n\n            setTimeout(function() {\n                $('.hidden-tag').tag();\n\n            }, 10);\n\n        }\n\n        self.filterItems = function(tag, parent, event) {\n\n            var $currentTag = $(event.target);\n\n            var $previousTag = $('.link-tag.isActive');\n\n\n\n            $previousTag.removeClass('isActive');\n            $currentTag.addClass('isActive');\n\n            if ($currentTag.hasClass('all')) {\n\n                self.setItems(self.allItems, true, true);\n\n            } else {\n\n                var specificItems = self.allItems.filter(function(item) {\n                    return item.tag == tag;\n                });\n\n                self.setItems(specificItems,false,true);\n\n            }\n\n            swiper.update();\n\n            $(document).click();\n\n        }\n\n    }\n\n    return ItemsModel;\n\n})\n"]}