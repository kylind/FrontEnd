"use strict";define(["jquery","knockout","knockout.mapping"],function(e,t,r){var n=function(e){var r=this;r.name=t.observable(e&&e.name?e.name:""),r.quantity=t.observable(e&&e.quantity?e.quantity:"1"),r.note=t.observable(e&&e.note?e.note:""),r.buyPrice=e&&!isNaN(e.buyPrice)?e.buyPrice:"",r.sellPrice=e&&!isNaN(e.sellPrice)?e.sellPrice:"",r.profit=e&&e.profit?e.profit:"",r.isDone=!(!e||"undefined"==typeof e.isDone)&&e.isDone,r.tag=e&&e.tag?e.tag:"",r.isChanged=!1,r.name.subscribe(function(e){r.isChanged=!0}),r.quantity.subscribe(function(e){r.isChanged=!0}),r.note.subscribe(function(e){r.isChanged=!0})},i=function(r){var i=this;i._id=t.observable(r&&r._id?r._id:""),i.client=t.observable(r&&r.client?r.client:""),i.packingStatus=t.observable(r&&r.packingStatus?r.packingStatus:"1ISREADY"),i.rate=r&&r.rate?r.rate:null,i.postage=r&&r.postage?r.postage:0,i.buyPrice=r&&r.buyPrice?r.buyPrice:"",i.sellPrice=r&&r.sellPrice?r.sellPrice:"",i.profit=r&&r.profit?r.profit:"",i.status=r&&r.status?r.status:"1RECEIVED",i.createDate=r&&r.createDate?r.createDate:"";var a=[];if(r&&e.isArray(r.items)&&r.items.length>0)r.items.forEach(function(e){a.push(new n(e))});else for(var s=0;s<3;s++)a.push(new n);i.items=t.observableArray(a),i.isChanged=!1,i.client.subscribe(function(e){i.isChanged=!0}),i.items.subscribe(function(e){i.isChanged=!0}),i.orderPackingStatus=t.pureComputed(function(){return"3PACKED"==i.packingStatus()?"font-green":"2NOTREADY"==i.packingStatus()?"font-yellow":"font-black"}),i.orderReadyStatus=t.pureComputed(function(){return"2NOTREADY"==i.packingStatus()?"icon-thumbsdown font-yellow":"icon-thumbsup font-black"})},a=function(r,a){function s(e){var t=[];if(Array.isArray(e)&&e.length>0)e.forEach(function(e){t.push(new i(e))});else for(var r=0;r<30;r++)t.push(new i);return t}function o(e){e.sort(function(e,t){var r=e.packingStatus(),n=t.packingStatus();return r==n?e.createDate<=t.createDate?1:-1:r<n?-1:1})}var u=a,c=this;c.setSwiper=function(e){u=e,u.update()};var f=s(r);c.orders=t.observableArray(f),c.setOrders=function(e,t){c.orders(s(e)),u.update()},c.addItem=function(e){e.items.unshift({name:"",quantity:1,note:"",buyPrice:"",sellPrice:"",isDone:!1}),u.update()},c.removeItem=function(e,t){t.items.remove(e),u.update()},c.submitOrder=function(r){arguments[3]();var n=arguments[4];console.log("post request....");var i=t.mapping.toJS(r);return e.post("./order",i,function(e,i){console.log("get post result"),t.mapping.fromJS(e,{},r),n()},"json"),!1},c.submitOrders=function(){arguments[3]();var r=arguments[4],i=c.orders(),a=e.parseJSON(t.toJSON(i));if(Array.isArray(a)&&a.length>0){var s=[],o=a.filter(function(e,t){var r=!1,n=""!=e.client;if(n)if(e.isChanged)r=!0;else for(var i=0;i<e.items.length;i++)if(e.items[i].isChanged){r=!0;break}return r&&s.push(t),r});o.length>0?e.post("./orders",{orders:o},function(a,o){a.forEach(function(r,a){var o=s[a];e.isArray(r.items)&&0==r.items.length&&(r.items=[{},{},{}]),t.mapping.fromJS(r,{items:{create:function(e){return new n(e.data)}}},i[o]),i[o].isChanged=!1}),r()},"json"):r()}return!1},c.markPackingStatus=function(t){arguments[3]();var r=arguments[4],n=(arguments[1],t._id()),i=t.packingStatus(),a=e(arguments[2].target),s="";return a.hasClass("icon-leaf")?"1ISREADY"==i?s="3PACKED":"3PACKED"==i&&(s="1ISREADY"):s="1ISREADY"==i||"3PACKED"==i?"2NOTREADY":"1ISREADY",""==s?void r():void e.ajax("./packingStatus/"+n,{success:function(n,i){if(t.packingStatus(s),""==e("#search-receivedOrders").val()){var a=c.orders();o(a),c.orders(a)}r()},data:{packingStatus:s},dataType:"json",type:"PUT"})},c.addOrder=function(){var t=new i;c.orders.unshift(t),u.update(),e(window).scrollTop(0)},c.removeOrder=function(t){arguments[3]();var r=arguments[4],n=t._id();return c.orders.remove(t),""==n?void r():(e.ajax("./order/"+n,{success:function(e,t){r()},dataType:"json",type:"DELETE"}),void u.update())};var r=null;c.searchOrders=function(t,n){var i=e(n.target).val();if(null==r&&(r=c.orders()),""==i){o(r);var a=r}else var a=r.filter(function(e){return e.client().indexOf(i)>=0});c.orders(a),setTimeout(function(){u.update()},100)}};return a});
//# sourceMappingURL=received-orders.js.map
